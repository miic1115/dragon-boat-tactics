<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paddle Zelos æˆ°è¡“æ¿</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dragon: {
                            dark: '#0f172a',
                            card: '#1e293b',
                            accent: '#06b6d4',
                            danger: '#ef4444',
                            success: '#22c55e',
                            water: '#3b82f6'
                        }
                    },
                    animation: { 'spin-slow': 'spin 3s linear infinite' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; }
        .boat-shape {
            clip-path: polygon(20% 0%, 80% 0%, 100% 5%, 100% 100%, 0% 100%, 0% 5%);
            transition: all 0.3s ease-in-out;
        }
        .seat-transition { transition: all 0.2s ease; }
        .selected-pulse { animation: pulse-border 1.5s infinite; border-color: #06b6d4 !important; }
        .selected-empty-pulse { animation: pulse-green 1.5s infinite; border-color: #22c55e !important; border-style: solid !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(6, 182, 212, 0); }
            100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
            padding-right: 2rem;
            -webkit-appearance: none; appearance: none;
        }
        option { color: white; background-color: #0f172a; padding: 8px; }
    </style>
</head>
<body>

<div id="app" v-cloak class="min-h-screen flex flex-col pb-36">
    <header class="bg-dragon-card p-2 sticky top-0 z-50 shadow-lg border-b border-slate-700">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-dragon text-dragon-accent text-lg"></i>
                <h1 class="font-bold text-sm tracking-wider">Paddle Zelos æˆ°è¡“æ¿ <span class="text-[10px] text-slate-400 font-normal hidden xs:inline">(è‡ªå‹•å­˜æª”)</span></h1>
            </div>
            <div class="flex gap-2">
                <button @click="clearAllBoats" class="bg-slate-700 text-red-400 px-2 py-1 rounded text-[10px] border border-slate-600 active:bg-slate-600">
                    <i class="fa-solid fa-trash-can"></i> æ¸…ç©º
                </button>
                <button @click="forceRefresh" class="bg-slate-700 text-dragon-accent px-2 py-1 rounded text-[10px] border border-slate-600 active:bg-slate-600">
                    <i :class="['fa-solid', isLoading ? 'fa-circle-notch fa-spin' : 'fa-rotate']"></i> <span v-if="hasPreset">æ›´æ–°åå–®</span><span v-else>è¨­å®š</span>
                </button>
            </div>
        </div>
        
        <div class="relative w-full">
            <div class="absolute inset-y-0 left-0 flex items-center pl-2 pointer-events-none">
                <i class="fa-regular fa-calendar text-slate-400 text-xs"></i>
            </div>
            <select v-model="selectedDate" @change="loadAttendanceForDate" 
                    class="bg-slate-800 border border-slate-600 text-white text-xs rounded focus:ring-dragon-accent focus:border-dragon-accent block w-full pl-8 p-2">
                <option value="" disabled>
                    {{ isLoading ? 'è³‡æ–™è®€å–ä¸­...' : (availableDates.length > 0 ? 'è«‹é¸æ“‡ç·´ç¿’æ—¥æœŸ...' : 'ç„¡è³‡æ–™') }}
                </option>
                <option v-for="date in availableDates" :key="date" :value="date">
                    {{ date }} ({{ getAttendanceCount(date) }}äºº)
                </option>
            </select>
        </div>
    </header>

    <div class="flex overflow-x-auto p-1 gap-2 bg-slate-800/90 sticky top-[80px] z-40 backdrop-blur-sm border-b border-slate-700 no-scrollbar">
        <button 
            v-for="(boat, index) in boats" 
            :key="boat.id"
            @click="switchBoat(index)"
            :class="['px-3 py-1 rounded-full whitespace-nowrap text-xs font-bold transition-all border flex items-center gap-1 flex-shrink-0', 
                     currentBoatIndex === index ? 'bg-dragon-water text-white border-blue-400 shadow-lg shadow-blue-500/30' : 'bg-slate-700 text-slate-400 border-transparent']"
        >
            <span v-if="selectedBoatIndex === index" class="text-dragon-accent animate-pulse text-[8px]">â—</span>
            <span>{{ boat.name }}</span>
        </button>
        <button @click="showCreateBoatModal = true" class="px-3 py-1 rounded-full bg-slate-700 text-slate-400 border border-transparent hover:bg-slate-600 hover:text-white transition flex-shrink-0 text-xs">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <div class="p-2 max-w-md mx-auto w-full flex-grow" v-if="currentBoat">
        
        <div class="flex justify-between text-[10px] text-slate-400 mb-2 px-4 bg-slate-800/50 py-2 rounded-lg border border-slate-700/50">
            <div class="text-center w-10"><div class="text-slate-500 uppercase">L</div><div class="font-bold text-sm text-white">{{ countPaddlers(currentBoat, 'left') }}</div></div>
            <div class="text-center flex flex-col justify-center">
                <span class="text-dragon-accent font-bold text-base leading-none">{{ countTotal(currentBoat) }}</span>
                <span class="text-[8px] uppercase tracking-wide text-slate-500">Total</span>
            </div>
            <div class="text-center w-10"><div class="text-slate-500 uppercase">R</div><div class="font-bold text-sm text-white">{{ countPaddlers(currentBoat, 'right') }}</div></div>
        </div>

        <div class="boat-shape bg-dragon-card border-x-[2px] border-dragon-accent/30 p-2 pb-8 relative shadow-2xl mx-auto transition-all duration-500"
             :style="{ minHeight: currentBoat.rowCount === 9 ? '480px' : '320px' }">
            
            <div class="flex justify-center mb-2">
                <div @click="handleSeatClick('drummer', 0)" 
                     :class="['w-10 h-10 rounded-full border-2 flex items-center justify-center flex-col cursor-pointer seat-transition relative overflow-hidden', 
                              getSeatClass('drummer', 0)]">
                    <span class="text-[6px] uppercase font-bold opacity-50 mb-px">Drum</span>
                    <span class="text-[10px] font-bold truncate w-full text-center px-0.5 z-10 relative leading-none">
                        {{ getPaddlerName(currentBoat.seats.drummer) }}
                    </span>
                </div>
            </div>

            <div class="space-y-1">
                <div v-for="row in currentBoat.rowCount" :key="row" class="flex justify-between items-center gap-1">
                    <div @click="handleSeatClick('left', row-1)" 
                         :class="['flex-1 h-9 rounded border flex items-center justify-between px-1 cursor-pointer seat-transition relative overflow-hidden group',
                                  getSeatClass('left', row-1)]">
                        <span class="text-[8px] font-mono opacity-30 absolute top-0.5 left-0.5">{{ row }}L</span>
                        <span class="font-bold text-xs truncate w-full text-center z-10">{{ getPaddlerName(currentBoat.seats.left[row-1]) }}</span>
                    </div>

                    <div class="w-3 flex justify-center">
                        <span class="text-[8px] text-slate-600 font-mono">{{ row }}</span>
                    </div>

                    <div @click="handleSeatClick('right', row-1)" 
                         :class="['flex-1 h-9 rounded border flex items-center justify-between px-1 cursor-pointer seat-transition relative overflow-hidden group',
                                  getSeatClass('right', row-1)]">
                        <span class="text-[8px] font-mono opacity-30 absolute top-0.5 right-0.5">{{ row }}R</span>
                        <span class="font-bold text-xs truncate w-full text-center z-10">{{ getPaddlerName(currentBoat.seats.right[row-1]) }}</span>
                    </div>
                </div>
            </div>

            <div class="flex justify-center mt-4">
                <div @click="handleSeatClick('steersman', 0)" 
                     :class="['w-10 h-10 rounded-full border-2 flex items-center justify-center flex-col cursor-pointer seat-transition relative overflow-hidden',
                              getSeatClass('steersman', 0)]">
                    <span class="text-[6px] uppercase font-bold opacity-50 mb-px">Helm</span>
                    <span class="text-[10px] font-bold truncate w-full text-center px-0.5 z-10 relative leading-none">
                        {{ getPaddlerName(currentBoat.seats.steersman) }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="px-4 pt-3 pb-24 border-t border-slate-800 bg-slate-900/95 backdrop-blur mt-auto z-30">
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-slate-400 font-bold text-[10px] uppercase tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-clipboard-user"></i> 
                <span v-if="selectedDate">{{ selectedDate }} ({{ bench.length }})</span>
                <span v-else>è«‹é¸æ—¥æœŸ</span>
            </h3>
            <button @click="openAddPaddlerModal('bench')" class="text-[10px] px-2 py-1 rounded bg-slate-800 border border-slate-700 text-slate-400 hover:text-white transition">
                <i class="fa-solid fa-plus"></i> è‡¨æ™‚äººå“¡
            </button>
        </div>

        <div class="grid grid-cols-4 gap-1.5 max-h-52 overflow-y-auto p-1">
            <div v-for="(paddler, index) in bench" :key="paddler.id" 
                 @click="handleBenchClick(index)"
                 :class="['p-1 rounded bg-slate-800 border border-slate-700 text-center cursor-pointer active:scale-95 transition relative min-h-[40px] flex flex-col justify-center select-none',
                          selectedFrom === 'bench' && selectedIndex === index ? 'ring-2 ring-dragon-accent bg-slate-700 z-10' : 'hover:bg-slate-700',
                          isOnBoat(paddler.id) ? 'opacity-30 grayscale' : '']">
                <div class="text-[11px] font-bold truncate w-full">{{ paddler.name }}</div>
                <div v-if="isOnBoat(paddler.id)" class="absolute inset-0 flex items-center justify-center">
                    <i class="fa-solid fa-check text-dragon-success text-lg drop-shadow-md"></i>
                </div>
            </div>
            <div v-if="bench.length === 0" class="col-span-4 text-center py-8 text-slate-500 text-xs italic border border-dashed border-slate-800 rounded bg-slate-900/50">
                <div v-if="isLoading">
                    <p><i class="fa-solid fa-circle-notch fa-spin text-dragon-accent"></i> æ­£åœ¨è®€å–...</p>
                </div>
                <div v-else-if="availableDates.length === 0">
                    <p v-if="hasPreset" class="text-red-400">è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚</p>
                    <p v-else class="mb-2">å°šæœªè¨­å®šåå–®é€£çµ</p>
                    <button v-if="!hasPreset" @click="openSyncModal" class="mt-2 text-dragon-accent underline">è¨­å®š</button>
                </div>
                <div v-else-if="!selectedDate">
                    <p>â˜ï¸ è«‹é¸æ“‡æ—¥æœŸ</p>
                </div>
                <div v-else>
                    <p>ç„¡äººå ±å ğŸ˜´</p>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showSyncModal" class="fixed inset-0 bg-black/90 z-[80] flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-slate-800 p-6 rounded-xl w-full max-w-lg border border-slate-600 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-white flex justify-between items-center">
                <span><i class="fa-solid fa-rotate mr-2 text-dragon-accent"></i>æ‰‹å‹•è¨­å®š</span>
                <button @click="showSyncModal = false" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </h3>
            
            <div class="flex gap-2 mb-4 border-b border-slate-700 pb-1">
                <button @click="syncMethod = 'file'" :class="['px-4 py-2 text-sm font-bold border-b-2 transition-colors', syncMethod === 'file' ? 'border-dragon-accent text-dragon-accent' : 'border-transparent text-slate-400']">ä¸Šå‚³æª”æ¡ˆ</button>
                <button @click="syncMethod = 'url'" :class="['px-4 py-2 text-sm font-bold border-b-2 transition-colors', syncMethod === 'url' ? 'border-dragon-accent text-dragon-accent' : 'border-transparent text-slate-400']">CSV é€£çµ</button>
            </div>

            <div v-if="syncMethod === 'file'">
                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-600 border-dashed rounded-lg cursor-pointer bg-slate-900 hover:bg-slate-800 transition">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-500 mb-2"></i>
                        <p class="text-sm text-slate-400">é»æ“Šä¸Šå‚³ CSV</p>
                    </div>
                    <input type="file" class="hidden" accept=".csv" @change="handleFileUpload" />
                </label>
            </div>

            <div v-if="syncMethod === 'url'">
                <input v-model="csvUrl" placeholder="è²¼ä¸Š CSV é€£çµ" 
                       class="w-full bg-slate-900 p-3 rounded border border-slate-700 text-sm text-white focus:outline-none focus:border-dragon-accent mb-3">
                <button @click="fetchCsvFromUrl" :disabled="isLoading" class="w-full py-3 rounded bg-dragon-accent text-black font-bold shadow-lg shadow-cyan-500/20 flex justify-center items-center gap-2">
                    <i v-if="isLoading" class="fa-solid fa-circle-notch fa-spin"></i>
                    <span v-else>åŒæ­¥</span>
                </button>
            </div>
        </div>
    </div>

    <div v-if="showAddPaddlerModal" class="fixed inset-0 bg-black/80 z-[60] flex items-end sm:items-center justify-center p-4 pb-10 sm:pb-4 animate-fade-in">
        <div class="bg-slate-800 p-6 rounded-xl w-full max-w-sm border border-slate-600 shadow-2xl mb-safe">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span v-if="addMode === 'bench'" class="text-dragon-accent"><i class="fa-solid fa-user-plus"></i> æ–°å¢è‡¨æ™‚</span>
                <span v-else class="text-dragon-success"><i class="fa-solid fa-chair"></i> ç›´æ¥å…¥åº§</span>
            </h3>
            <input ref="nameInput" v-model="newPaddlerName" placeholder="è¼¸å…¥å§“å..." 
                   class="w-full bg-slate-900 p-4 rounded-lg border border-slate-700 mb-4 text-white text-lg focus:outline-none focus:border-dragon-accent placeholder-slate-600"
                   @keyup.enter="confirmAddPaddler">
            
            <div class="flex gap-3">
                <button @click="showAddPaddlerModal = false" class="flex-1 py-3 rounded-lg bg-slate-700 font-bold text-slate-300">å–æ¶ˆ</button>
                <button @click="confirmAddPaddler" class="flex-1 py-3 rounded-lg bg-dragon-accent text-black font-bold shadow-lg shadow-cyan-500/20">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div v-if="showCreateBoatModal" class="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-xl w-full max-w-sm border border-slate-600 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-white">æ–°å¢é¾èˆŸ</h3>
            <div class="mb-4">
                <label class="block text-xs text-slate-400 mb-1">èˆ¹éšŠåç¨±</label>
                <input v-model="newBoatName" placeholder="ä¾‹å¦‚ï¼šæ··åˆçµ„ C" 
                       class="w-full bg-slate-900 p-3 rounded border border-slate-700 text-white focus:outline-none focus:border-dragon-accent">
            </div>
            <div class="mb-6">
                <label class="block text-xs text-slate-400 mb-2">èˆ¹å‹é¸æ“‡</label>
                <div class="grid grid-cols-2 gap-3">
                    <button @click="newBoatType = 'big'" 
                            :class="['p-4 rounded border flex flex-col items-center transition', newBoatType === 'big' ? 'bg-dragon-accent/20 border-dragon-accent text-dragon-accent' : 'bg-slate-900 border-slate-700 text-slate-500']">
                        <span class="text-2xl mb-1"><i class="fa-solid fa-ship"></i></span>
                        <span class="font-bold">å¤§é¾ (18äºº)</span>
                    </button>
                    <button @click="newBoatType = 'small'" 
                            :class="['p-4 rounded border flex flex-col items-center transition', newBoatType === 'small' ? 'bg-dragon-accent/20 border-dragon-accent text-dragon-accent' : 'bg-slate-900 border-slate-700 text-slate-500']">
                        <span class="text-xl mb-1 mt-1"><i class="fa-solid fa-sailboat"></i></span>
                        <span class="font-bold">å°é¾ (10äºº)</span>
                    </button>
                </div>
            </div>
            <div class="flex gap-3">
                <button @click="showCreateBoatModal = false" class="flex-1 py-3 rounded bg-slate-700 text-slate-300 font-bold">å–æ¶ˆ</button>
                <button @click="confirmCreateBoat" class="flex-1 py-3 rounded bg-dragon-accent text-black font-bold">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <div v-if="selectedFrom" class="fixed bottom-6 left-4 right-4 z-50 flex gap-2 justify-center animate-slide-up max-w-md mx-auto">
        
        <div v-if="isSelectedEmptySeat()" class="flex-1 flex gap-2 items-center bg-slate-800 p-2 rounded-lg shadow-xl border border-slate-600">
            <div class="flex-1 relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <i class="fa-solid fa-user-plus text-dragon-success"></i>
                </div>
                <select @change="quickPlacePaddler($event)" class="w-full bg-slate-900 border border-slate-700 text-white text-sm rounded-lg focus:ring-dragon-success focus:border-dragon-success block pl-9 p-2.5 appearance-none">
                    <option selected disabled value="">å¿«é€Ÿå…¥åº§ ({{ availableBench.length }}äºº)</option>
                    <option value="NEW">+ æ–°å¢è‡¨æ™‚äººå“¡</option>
                    <option v-for="p in availableBench" :key="p.id" :value="JSON.stringify(p)">{{ p.name }}</option>
                </select>
            </div>
            <button @click="cancelSelection" class="bg-slate-600 text-white w-10 h-10 rounded flex items-center justify-center hover:bg-slate-500">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div v-else class="flex gap-2 w-full">
            <div class="bg-slate-800 text-white px-4 py-3 rounded-lg shadow-xl border border-slate-600 flex flex-col justify-center items-start flex-1 min-w-0">
                <span class="text-[10px] text-slate-400 uppercase tracking-wider">å·²é¸å–</span>
                <span class="font-bold truncate w-full text-dragon-accent flex items-center text-sm">
                    <i class="fa-solid fa-check-circle mr-2"></i> {{ getSelectedName() }}
                </span>
            </div>
            <button @click="removeSelectedFromBoat" class="bg-dragon-danger text-white px-4 py-3 rounded-lg shadow-xl font-bold hover:bg-red-600 transition flex items-center gap-2 whitespace-nowrap">
                <i class="fa-solid fa-arrow-down"></i> <span class="hidden xs:inline">ä¸‹èˆ¹</span>
            </button>
            <button @click="cancelSelection" class="bg-slate-600 text-white px-4 py-3 rounded-lg shadow-xl font-bold whitespace-nowrap active:bg-slate-500">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, nextTick, onMounted, watch } = Vue;

    // ==========================================
    // ğŸ”¥ è¨­å®šå€ï¼šè«‹åœ¨é€™è£¡è²¼ä¸Šä½ çš„ Google CSV é€£çµ
    // ==========================================
    const PRESET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTeAi-38Jj_Y3oWpvqsUpYetYmsFhZaV90fy9lez8cD04MEkF2T_jgD4kQUndkol7fIn4RrrPJPmrY6/pub?gid=1280092366&single=true&output=csv'; 
    // ä¾‹å¦‚ï¼š 'https://docs.google.com/spreadsheets/d/e/......./pub?output=csv'

    createApp({
        setup() {
            const createEmptySeats = (rows) => ({ drummer: null, steersman: null, left: Array(rows).fill(null), right: Array(rows).fill(null) });

            // State
            const boats = ref([
                { id: 1, name: 'å¤§é¾ A', rowCount: 9, seats: createEmptySeats(9) },
                { id: 2, name: 'å°é¾ B', rowCount: 5, seats: createEmptySeats(5) }
            ]);
            
            const attendanceDB = ref({});
            const availableDates = ref([]);
            const selectedDate = ref("");
            const bench = ref([]);
            const hasPreset = ref(false);
            
            const showSyncModal = ref(false);
            const syncMethod = ref('file');
            const csvUrl = ref('');
            const isLoading = ref(false);
            const lastSyncTime = ref('');

            const currentBoatIndex = ref(0);
            const showAddPaddlerModal = ref(false);
            const showCreateBoatModal = ref(false);
            const addMode = ref('bench');
            const nameInput = ref(null);
            const newPaddlerName = ref('');
            const newBoatName = ref('');
            const newBoatType = ref('big');
            const selectedFrom = ref(null); 
            const selectedIndex = ref(null); 
            const selectedBoatIndex = ref(null); 

            const currentBoat = computed(() => boats.value[currentBoatIndex.value] || null);

            // --- SAVE & LOAD STATE (LocalStorage) ---
            const saveState = () => {
                try {
                    localStorage.setItem('dragon_boats_state', JSON.stringify(boats.value));
                    localStorage.setItem('dragon_selected_date', selectedDate.value);
                } catch (e) { console.error("Save failed", e); }
            };

            const loadState = () => {
                const savedBoats = localStorage.getItem('dragon_boats_state');
                if (savedBoats) {
                    try {
                        boats.value = JSON.parse(savedBoats);
                    } catch (e) { console.error("Load failed", e); }
                }
                const savedDate = localStorage.getItem('dragon_selected_date');
                if (savedDate) selectedDate.value = savedDate;
            };

            // Watch for changes in boats to Auto-Save
            watch(boats, () => { saveState(); }, { deep: true });
            watch(selectedDate, () => { saveState(); });

            // --- Initialization ---
            onMounted(() => {
                loadState(); // Load saved boats arrangement immediately

                if (PRESET_CSV_URL && PRESET_CSV_URL.length > 10) {
                    hasPreset.value = true;
                    csvUrl.value = PRESET_CSV_URL;
                    
                    const savedData = localStorage.getItem('dragon_csv_data');
                    if (savedData) {
                        parseCSV(savedData);
                        // Restore selected date logic handled in parseCSV or loadState
                        fetchCsvFromUrl(true); 
                    } else {
                        fetchCsvFromUrl();
                    }
                } else {
                    const savedUrl = localStorage.getItem('dragon_csv_url');
                    const savedData = localStorage.getItem('dragon_csv_data');
                    if (savedUrl) csvUrl.value = savedUrl;
                    if (savedData) parseCSV(savedData);
                    else showSyncModal.value = true;
                }
            });

            const forceRefresh = () => {
                if(hasPreset.value) fetchCsvFromUrl();
                else showSyncModal.value = true;
            }

            // --- Helper: Check if paddler is on ANY boat ---
            const isOnBoat = (paddlerId) => {
                for (const boat of boats.value) {
                    if (boat.seats.drummer?.id === paddlerId) return true;
                    if (boat.seats.steersman?.id === paddlerId) return true;
                    if (boat.seats.left.some(p => p?.id === paddlerId)) return true;
                    if (boat.seats.right.some(p => p?.id === paddlerId)) return true;
                }
                return false;
            };

            const availableBench = computed(() => {
                return bench.value.filter(p => !isOnBoat(p.id));
            });

            // --- Quick Place Logic ---
            const quickPlacePaddler = (event) => {
                const value = event.target.value;
                if (value === "NEW") {
                    openAddPaddlerModal('seat');
                    event.target.value = "";
                    return;
                }
                if (!value) return;
                try {
                    const paddler = JSON.parse(value);
                    const boat = boats.value[selectedBoatIndex.value];
                    if (['drummer', 'steersman'].includes(selectedFrom.value)) {
                        boat.seats[selectedFrom.value] = paddler;
                    } else {
                        boat.seats[selectedFrom.value][selectedIndex.value] = paddler;
                    }
                    cancelSelection();
                } catch (e) { console.error("Quick place error", e); }
            };

            // --- CSV / Sync Logic ---
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { processCsvText(e.target.result); showSyncModal.value = false; alert("æª”æ¡ˆè®€å–æˆåŠŸï¼"); };
                reader.readAsText(file);
            };

            const processCsvText = (text) => {
                parseCSV(text);
                localStorage.setItem('dragon_csv_data', text);
                const now = new Date().toLocaleString();
                lastSyncTime.value = now;
            };

            const openSyncModal = () => {
                if(hasPreset.value) {
                    if(confirm("æ‚¨å·²ç¶“è¨­å®šäº†è‡ªå‹•åŒæ­¥é€£çµï¼Œè¦ç«‹å³æ›´æ–°åå–®å—ï¼Ÿ")) {
                        fetchCsvFromUrl();
                    }
                } else {
                    showSyncModal.value = true;
                }
            };

            const fetchCsvFromUrl = async (isBackground = false) => {
                if (!csvUrl.value) return;
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(csvUrl.value);
                if(!isBackground) isLoading.value = true;
                try {
                    const res = await fetch(proxyUrl);
                    if (!res.ok) throw new Error("Network err");
                    const text = await res.text();
                    if (!text || text.length < 10) throw new Error("Empty data");
                    processCsvText(text);
                    if(!hasPreset.value) localStorage.setItem('dragon_csv_url', csvUrl.value);
                    if(!isBackground) {
                        showSyncModal.value = false;
                        alert("åŒæ­¥æˆåŠŸï¼åå–®å·²æ›´æ–°ã€‚");
                    }
                } catch (e) { 
                    if(!isBackground) alert("åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é€£çµã€‚"); 
                } finally { 
                    if(!isBackground) isLoading.value = false; 
                }
            };

            const clearStorage = () => {
                if(!confirm("æ¸…é™¤è¨­å®šï¼Ÿ")) return;
                localStorage.removeItem('dragon_csv_url'); localStorage.removeItem('dragon_csv_data');
                attendanceDB.value = {}; availableDates.value = []; bench.value = []; selectedDate.value = ''; 
                if(!hasPreset.value) csvUrl.value = '';
                alert("å·²é‡ç½®");
            };

            const parseCSV = (csvText) => {
                const lines = csvText.trim().split(/\r?\n/); 
                if (lines.length < 10) return;
                const headers = lines[0].split(',').map(h => h.trim());
                let startRow = 7;
                for(let i=0; i<20; i++) { if(lines[i] && lines[i].startsWith('åå–®')) { startRow = i; break; } }

                const db = {};
                const validDateCols = [];
                for(let j = 4; j < headers.length; j++) { if(headers[j]) { validDateCols.push({ index: j, date: headers[j] }); db[headers[j]] = []; } }

                for(let colObj of validDateCols) {
                    const j = colObj.index;
                    const dateKey = colObj.date;
                    for(let i = startRow; i < lines.length; i++) {
                        const row = lines[i].split(',').map(c => c.trim());
                        if(row.length <= j) continue;
                        const name = row[j];
                        if(isName(name)) {
                            db[dateKey].push({ id: `${name}-${dateKey}-${i}`, name: name, side: 'both' });
                        }
                    }
                }
                attendanceDB.value = db;
                availableDates.value = validDateCols.map(d => d.date).reverse();
                if (availableDates.value.length > 0 && !selectedDate.value) { selectedDate.value = availableDates.value[0]; loadAttendanceForDate(); }
            };

            const isName = (str) => {
                if(!str) return false;
                if(['on going', 'NaN', 'undefined', 'å‡ºå¸­åå–®'].includes(str)) return false;
                if(!isNaN(str) && !isNaN(parseFloat(str))) return false;
                return true;
            };

            const loadAttendanceForDate = () => { if (!selectedDate.value || !attendanceDB.value[selectedDate.value]) return; bench.value = JSON.parse(JSON.stringify(attendanceDB.value[selectedDate.value])); cancelSelection(); };
            const getAttendanceCount = (date) => attendanceDB.value[date] ? attendanceDB.value[date].length : 0;
            const clearAllBoats = () => { if(!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ’ä½å—ï¼Ÿ\n(é€™æœƒè¦†è“‹æ‚¨çš„æš«å­˜ç´€éŒ„)")) return; boats.value.forEach(boat => { boat.seats.drummer=null; boat.seats.steersman=null; boat.seats.left.fill(null); boat.seats.right.fill(null); }); };

            // --- Interaction ---
            const getPaddlerName = (paddler) => paddler ? paddler.name : (paddler === null ? '' : '-');
            const getSeatClass = (section, index) => {
                if (!currentBoat.value) return '';
                const boat = currentBoat.value;
                if ((section === 'left' || section === 'right') && boat.seats[section][index] === undefined) return 'opacity-0 pointer-events-none';
                const isSelectedHere = selectedBoatIndex.value === currentBoatIndex.value && selectedFrom.value === section && selectedIndex.value === index;
                let content = (section === 'drummer' || section === 'steersman') ? boat.seats[section] : boat.seats[section][index];
                if (isSelectedHere) return content ? 'bg-dragon-accent text-black border-dragon-accent selected-pulse z-20 shadow-lg' : 'bg-slate-800 border-dragon-success text-dragon-success selected-empty-pulse z-20 shadow-lg';
                if (content) return 'bg-slate-700 text-white border-slate-500 shadow-md';
                return 'bg-slate-900/30 text-slate-600 border-dashed border-slate-800 hover:border-slate-600';
            };
            const handleBenchClick = (index) => { if (selectedFrom.value === 'bench' && selectedIndex.value === index) cancelSelection(); else if (selectedFrom.value) executeSwap('bench', index, null); else { selectedFrom.value = 'bench'; selectedIndex.value = index; selectedBoatIndex.value = null; } };
            const handleSeatClick = (section, index) => { if (selectedBoatIndex.value === currentBoatIndex.value && selectedFrom.value === section && selectedIndex.value === index) { cancelSelection(); return; } if (selectedFrom.value) executeSwap(section, index, currentBoatIndex.value); else { selectedFrom.value = section; selectedIndex.value = index; selectedBoatIndex.value = currentBoatIndex.value; } };
            
            const executeSwap = (targetSection, targetIndex, targetBoatIdx) => {
                let sourceVal, targetVal;
                if (selectedFrom.value === 'bench') sourceVal = bench.value[selectedIndex.value];
                else { const srcBoat = boats.value[selectedBoatIndex.value]; sourceVal = ['drummer', 'steersman'].includes(selectedFrom.value) ? srcBoat.seats[selectedFrom.value] : srcBoat.seats[selectedFrom.value][selectedIndex.value]; }
                if (targetSection === 'bench') targetVal = bench.value[targetIndex];
                else { const tgtBoat = boats.value[targetBoatIdx]; targetVal = ['drummer', 'steersman'].includes(targetSection) ? tgtBoat.seats[targetSection] : tgtBoat.seats[targetSection][targetIndex]; }
                if (!sourceVal && !targetVal) { cancelSelection(); return; }
                if (selectedFrom.value !== 'bench') { const srcBoat = boats.value[selectedBoatIndex.value]; if (['drummer', 'steersman'].includes(selectedFrom.value)) srcBoat.seats[selectedFrom.value] = targetVal; else srcBoat.seats[selectedFrom.value][selectedIndex.value] = targetVal; }
                if (targetSection !== 'bench') { const tgtBoat = boats.value[targetBoatIdx]; const valToPlace = (selectedFrom.value === 'bench') ? {...sourceVal} : sourceVal; if (['drummer', 'steersman'].includes(targetSection)) tgtBoat.seats[targetSection] = valToPlace; else tgtBoat.seats[targetSection][targetIndex] = valToPlace; }
                cancelSelection();
            };
            const isSelectedEmptySeat = () => { if (selectedBoatIndex.value === null) return false; const boat = boats.value[selectedBoatIndex.value]; const s = selectedFrom.value; const i = selectedIndex.value; try { return (['drummer', 'steersman'].includes(s)) ? boat.seats[s] === null : boat.seats[s][i] === null; } catch (e) { return false; } };
            const removeSelectedFromBoat = () => { if (selectedBoatIndex.value === null) return; const boat = boats.value[selectedBoatIndex.value]; if (['drummer', 'steersman'].includes(selectedFrom.value)) boat.seats[selectedFrom.value] = null; else boat.seats[selectedFrom.value][selectedIndex.value] = null; cancelSelection(); };
            const openAddPaddlerModal = (mode) => { addMode.value = mode; newPaddlerName.value = ''; showAddPaddlerModal.value = true; nextTick(() => { if(nameInput.value) nameInput.value.focus(); }); };
            const confirmAddPaddler = () => { if (!newPaddlerName.value) return; const newGuy = { id: Date.now(), name: newPaddlerName.value, side: 'both' }; if (addMode.value === 'bench') bench.value.push(newGuy); else { const boat = boats.value[selectedBoatIndex.value]; if (['drummer', 'steersman'].includes(selectedFrom.value)) boat.seats[selectedFrom.value] = newGuy; else boat.seats[selectedFrom.value][selectedIndex.value] = newGuy; cancelSelection(); } showAddPaddlerModal.value = false; };
            const confirmCreateBoat = () => { const name = newBoatName.value || `æ–°èˆ¹éšŠ ${boats.value.length + 1}`; const rows = newBoatType.value === 'big' ? 9 : 5; boats.value.push({ id: Date.now(), name: name, rowCount: rows, seats: createEmptySeats(rows) }); currentBoatIndex.value = boats.value.length - 1; showCreateBoatModal.value = false; newBoatName.value = ''; };
            const switchBoat = (index) => currentBoatIndex.value = index;
            const cancelSelection = () => { selectedFrom.value = null; selectedIndex.value = null; selectedBoatIndex.value = null; };
            const getSelectedName = () => { if (selectedFrom.value === 'bench') return bench.value[selectedIndex.value]?.name; if (selectedBoatIndex.value === null) return ''; const boat = boats.value[selectedBoatIndex.value]; if(!boat) return ''; const val = ['drummer', 'steersman'].includes(selectedFrom.value) ? boat.seats[selectedFrom.value] : boat.seats[selectedFrom.value][selectedIndex.value]; return val ? val.name : 'ç©ºä½'; };
            const countPaddlers = (boat, side) => boat ? boat.seats[side].filter(p => p !== null).length : 0;
            const countTotal = (boat) => { if(!boat) return 0; let count = 0; if(boat.seats.drummer) count++; if(boat.seats.steersman) count++; count += countPaddlers(boat, 'left'); count += countPaddlers(boat, 'right'); return count; };

            return {
                boats, currentBoatIndex, currentBoat, bench, availableBench,
                selectedFrom, selectedIndex, selectedBoatIndex,
                showAddPaddlerModal, addMode, newPaddlerName, nameInput,
                showCreateBoatModal, newBoatName, newBoatType,
                showSyncModal, syncMethod, csvUrl, isLoading, lastSyncTime,
                getPaddlerName, getSeatClass, handleBenchClick, handleSeatClick,
                switchBoat, cancelSelection, getSelectedName,
                openAddPaddlerModal, confirmAddPaddler, confirmCreateBoat,
                isSelectedEmptySeat, removeSelectedFromBoat,
                countPaddlers, countTotal, fetchCsvFromUrl, handleFileUpload,
                openSyncModal, clearStorage, availableDates, selectedDate, loadAttendanceForDate, getAttendanceCount, isOnBoat, clearAllBoats,
                quickPlacePaddler, hasPreset, forceRefresh
            };
        }
    }).mount('#app');
</script>
</body>
</html>
