<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é¾èˆŸæˆ°è¡“æ¿ V5 - å®Œç¾è§£æç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dragon: {
                            dark: '#0f172a',
                            card: '#1e293b',
                            accent: '#06b6d4',
                            danger: '#ef4444',
                            success: '#22c55e',
                            water: '#3b82f6'
                        }
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: white; -webkit-tap-highlight-color: transparent; }
        .boat-shape {
            clip-path: polygon(20% 0%, 80% 0%, 100% 5%, 100% 100%, 0% 100%, 0% 5%);
            transition: all 0.3s ease-in-out;
        }
        .seat-transition { transition: all 0.2s ease; }
        .selected-pulse { animation: pulse-border 1.5s infinite; border-color: #06b6d4 !important; }
        .selected-empty-pulse { animation: pulse-green 1.5s infinite; border-color: #22c55e !important; border-style: solid !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(6, 182, 212, 0); }
            100% { box-shadow: 0 0 0 0 rgba(6, 182, 212, 0); }
        }
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); }
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none; appearance: none;
        }
    </style>
</head>
<body>

<div id="app" v-cloak class="min-h-screen flex flex-col pb-36">
    <header class="bg-dragon-card p-3 sticky top-0 z-50 shadow-lg border-b border-slate-700">
        <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-dragon text-dragon-accent text-xl"></i>
                <h1 class="font-bold text-base tracking-wider">æˆ°è¡“æ¿ V5</h1>
            </div>
            <div class="flex gap-2">
                <button @click="clearAllBoats" class="bg-slate-700 text-red-400 px-2 py-1 rounded text-xs border border-slate-600 active:bg-slate-600">
                    <i class="fa-solid fa-trash-can"></i> æ¸…ç©º
                </button>
                <button @click="openSyncModal" class="bg-slate-700 text-dragon-accent px-2 py-1 rounded text-xs border border-slate-600 active:bg-slate-600">
                    <i :class="['fa-solid', isLoading ? 'fa-circle-notch fa-spin' : 'fa-rotate']"></i> åŒæ­¥/ä¸Šå‚³
                </button>
            </div>
        </div>
        
        <div class="relative w-full">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <i class="fa-regular fa-calendar text-slate-400"></i>
            </div>
            <select v-model="selectedDate" @change="loadAttendanceForDate" 
                    class="bg-slate-800 border border-slate-600 text-white text-sm rounded-lg focus:ring-dragon-accent focus:border-dragon-accent block w-full pl-10 p-2.5">
                <option value="" disabled>è«‹é¸æ“‡ç·´ç¿’æ—¥æœŸ...</option>
                <option v-for="date in availableDates" :key="date" :value="date">
                    {{ date }} ({{ getAttendanceCount(date) }}äºº)
                </option>
            </select>
        </div>
    </header>

    <div class="flex overflow-x-auto p-2 gap-2 bg-slate-800/90 sticky top-[88px] z-40 backdrop-blur-sm border-b border-slate-700 no-scrollbar">
        <button 
            v-for="(boat, index) in boats" 
            :key="boat.id"
            @click="switchBoat(index)"
            :class="['px-3 py-1.5 rounded-full whitespace-nowrap text-xs font-bold transition-all border flex items-center gap-2 flex-shrink-0', 
                     currentBoatIndex === index ? 'bg-dragon-water text-white border-blue-400 shadow-lg shadow-blue-500/30' : 'bg-slate-700 text-slate-400 border-transparent']"
        >
            <span v-if="selectedBoatIndex === index" class="text-dragon-accent animate-pulse text-[8px] mr-[-4px]">â—</span>
            <span>{{ boat.name }}</span>
            <span class="text-[8px] px-1 py-0.5 rounded bg-black/20 ml-1">
                {{ boat.rowCount === 9 ? 'å¤§' : 'å°' }}
            </span>
        </button>
        <button @click="showCreateBoatModal = true" class="px-3 py-1.5 rounded-full bg-slate-700 text-slate-400 border border-transparent hover:bg-slate-600 hover:text-white transition flex-shrink-0">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <div class="p-4 max-w-md mx-auto w-full flex-grow" v-if="currentBoat">
        
        <div class="flex justify-between text-xs text-slate-400 mb-4 px-4 bg-slate-800/50 py-3 rounded-xl border border-slate-700/50">
            <div class="text-center w-16"><div class="text-slate-500 text-[10px] uppercase">Left</div><div class="font-bold text-lg text-white">{{ countPaddlers(currentBoat, 'left') }}</div></div>
            <div class="text-center flex flex-col justify-center">
                <span class="text-dragon-accent font-bold text-xl leading-none">{{ countTotal(currentBoat) }}</span>
                <span class="text-[9px] uppercase tracking-wide text-slate-500">Total</span>
            </div>
            <div class="text-center w-16"><div class="text-slate-500 text-[10px] uppercase">Right</div><div class="font-bold text-lg text-white">{{ countPaddlers(currentBoat, 'right') }}</div></div>
        </div>

        <div class="boat-shape bg-dragon-card border-x-[3px] border-dragon-accent/30 p-4 pb-10 relative shadow-2xl mx-auto transition-all duration-500"
             :style="{ minHeight: currentBoat.rowCount === 9 ? '600px' : '400px' }">
            
            <div class="flex justify-center mb-4">
                <div @click="handleSeatClick('drummer', 0)" 
                     :class="['w-14 h-14 rounded-full border-2 flex items-center justify-center flex-col cursor-pointer seat-transition relative overflow-hidden', 
                              getSeatClass('drummer', 0)]">
                    <span class="text-[8px] uppercase font-bold opacity-50 mb-0.5">Drum</span>
                    <span class="text-xs font-bold truncate w-full text-center px-1 z-10 relative">
                        {{ getPaddlerName(currentBoat.seats.drummer) }}
                    </span>
                </div>
            </div>

            <div class="space-y-2">
                <div v-for="row in currentBoat.rowCount" :key="row" class="flex justify-between items-center gap-2">
                    <div @click="handleSeatClick('left', row-1)" 
                         :class="['flex-1 h-12 rounded border flex items-center justify-between px-2 cursor-pointer seat-transition relative overflow-hidden group',
                                  getSeatClass('left', row-1)]">
                        <span class="text-[10px] font-mono opacity-30 absolute top-1 left-1">{{ row }}L</span>
                        <span class="font-bold text-sm truncate w-full text-center z-10">{{ getPaddlerName(currentBoat.seats.left[row-1]) }}</span>
                    </div>

                    <div class="w-4 flex justify-center">
                        <span class="text-[10px] text-slate-600 font-mono">{{ row }}</span>
                    </div>

                    <div @click="handleSeatClick('right', row-1)" 
                         :class="['flex-1 h-12 rounded border flex items-center justify-between px-2 cursor-pointer seat-transition relative overflow-hidden group',
                                  getSeatClass('right', row-1)]">
                        <span class="text-[10px] font-mono opacity-30 absolute top-1 right-1">{{ row }}R</span>
                        <span class="font-bold text-sm truncate w-full text-center z-10">{{ getPaddlerName(currentBoat.seats.right[row-1]) }}</span>
                    </div>
                </div>
            </div>

            <div class="flex justify-center mt-8">
                <div @click="handleSeatClick('steersman', 0)" 
                     :class="['w-14 h-14 rounded-full border-2 flex items-center justify-center flex-col cursor-pointer seat-transition relative overflow-hidden',
                              getSeatClass('steersman', 0)]">
                    <span class="text-[8px] uppercase font-bold opacity-50 mb-0.5">Helm</span>
                    <span class="text-xs font-bold truncate w-full text-center px-1 z-10 relative">
                        {{ getPaddlerName(currentBoat.seats.steersman) }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="px-4 pt-4 pb-24 border-t border-slate-800 bg-slate-900/95 backdrop-blur mt-auto z-30">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-slate-400 font-bold text-xs uppercase tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-clipboard-user"></i> 
                <span v-if="selectedDate">{{ selectedDate }} å‡ºå¸­åå–® ({{ bench.length }})</span>
                <span v-else>è«‹é¸æ“‡ä¸Šæ–¹æ—¥æœŸ</span>
            </h3>
            <button @click="openAddPaddlerModal('bench')" class="text-[10px] px-2 py-1 rounded bg-slate-800 border border-slate-700 text-slate-400 hover:text-white transition">
                <i class="fa-solid fa-plus"></i> è‡¨æ™‚äººå“¡
            </button>
        </div>

        <div class="grid grid-cols-4 gap-2 max-h-60 overflow-y-auto p-1">
            <div v-for="(paddler, index) in bench" :key="paddler.id" 
                 @click="handleBenchClick(index)"
                 :class="['p-1.5 rounded bg-slate-800 border border-slate-700 text-center cursor-pointer active:scale-95 transition relative min-h-[45px] flex flex-col justify-center select-none',
                          selectedFrom === 'bench' && selectedIndex === index ? 'ring-2 ring-dragon-accent bg-slate-700 z-10' : 'hover:bg-slate-700',
                          isOnBoat(paddler.id) ? 'opacity-30 grayscale' : '']">
                <div class="text-xs font-bold truncate w-full">{{ paddler.name }}</div>
                <div class="text-[9px] mt-0.5 scale-90 font-bold">
                    <span v-if="paddler.side === 'left'" class="text-blue-400">Left</span>
                    <span v-else-if="paddler.side === 'right'" class="text-green-400">Right</span>
                    <span v-else class="text-purple-400">Both/Helm</span>
                </div>
                <div v-if="isOnBoat(paddler.id)" class="absolute inset-0 flex items-center justify-center">
                    <i class="fa-solid fa-check text-dragon-success text-lg drop-shadow-md"></i>
                </div>
            </div>
            <div v-if="bench.length === 0" class="col-span-4 text-center py-8 text-slate-500 text-xs italic border border-dashed border-slate-800 rounded bg-slate-900/50">
                <div v-if="availableDates.length === 0">
                    <p class="mb-2"><i class="fa-solid fa-triangle-exclamation text-yellow-500 text-xl"></i></p>
                    <p>å°šæœªè¼‰å…¥åå–®</p>
                    <button @click="openSyncModal" class="mt-2 text-dragon-accent underline">é»æ­¤ä¸Šå‚³æˆ–åŒæ­¥</button>
                </div>
                <div v-else-if="!selectedDate">
                    <p>â˜ï¸ è«‹é»æ“Šæœ€ä¸Šæ–¹çš„æ—¥æœŸé¸å–®</p>
                </div>
                <div v-else>
                    <p>é€™ä¸€å¤©ç„¡äººå ±å ğŸ˜´</p>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showSyncModal" class="fixed inset-0 bg-black/90 z-[80] flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-slate-800 p-6 rounded-xl w-full max-w-lg border border-slate-600 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-white flex justify-between items-center">
                <span><i class="fa-solid fa-rotate mr-2 text-dragon-accent"></i>åŒæ­¥è¨­å®š</span>
                <button @click="showSyncModal = false" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </h3>
            
            <div class="flex gap-2 mb-4 border-b border-slate-700 pb-1">
                <button @click="syncMethod = 'file'" :class="['px-4 py-2 text-sm font-bold border-b-2 transition-colors', syncMethod === 'file' ? 'border-dragon-accent text-dragon-accent' : 'border-transparent text-slate-400']">ä¸Šå‚³æª”æ¡ˆ (æ¨è–¦)</button>
                <button @click="syncMethod = 'url'" :class="['px-4 py-2 text-sm font-bold border-b-2 transition-colors', syncMethod === 'url' ? 'border-dragon-accent text-dragon-accent' : 'border-transparent text-slate-400']">è‡ªå‹•åŒæ­¥</button>
            </div>

            <div v-if="syncMethod === 'file'">
                <p class="text-xs text-slate-400 mb-3">è«‹ä¸Šå‚³æ‚¨çš„ã€Œå‡ºå¸­çµ±è¨ˆè¡¨ã€CSV æª”æ¡ˆï¼š</p>
                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-600 border-dashed rounded-lg cursor-pointer bg-slate-900 hover:bg-slate-800 transition">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-500 mb-2"></i>
                        <p class="text-sm text-slate-400"><span class="font-bold">é»æ“Šä¸Šå‚³</span> æˆ–æ‹–æ”¾æª”æ¡ˆ</p>
                        <p class="text-xs text-slate-500">æ”¯æ´ CSV æ ¼å¼</p>
                    </div>
                    <input type="file" class="hidden" accept=".csv" @change="handleFileUpload" />
                </label>
            </div>

            <div v-if="syncMethod === 'url'">
                <div class="bg-blue-500/10 border border-blue-500/20 p-3 rounded mb-4 text-xs text-blue-200">
                    <p class="font-bold mb-1">ğŸ”¥ å¦‚ä½•è¨­å®šï¼š</p>
                    <ol class="list-decimal list-inside space-y-1 opacity-80">
                        <li>Google Sheets > æª”æ¡ˆ > å…±ç”¨ > <strong>ç™¼å¸ƒåˆ°ç¶²è·¯</strong></li>
                        <li>é¸æ“‡çµ±è¨ˆè¡¨åˆ†é ï¼Œæ ¼å¼é¸ <strong>CSV</strong></li>
                        <li>è²¼ä¸Šé€£çµ</li>
                    </ol>
                </div>
                <input v-model="csvUrl" placeholder="è²¼ä¸Š https://docs.google.com/...output=csv" 
                       class="w-full bg-slate-900 p-3 rounded border border-slate-700 text-sm text-white focus:outline-none focus:border-dragon-accent mb-3">
                <button @click="fetchCsvFromUrl" :disabled="isLoading" class="w-full py-3 rounded bg-dragon-accent text-black font-bold shadow-lg shadow-cyan-500/20 flex justify-center items-center gap-2">
                    <i v-if="isLoading" class="fa-solid fa-circle-notch fa-spin"></i>
                    <span v-else>é–‹å§‹åŒæ­¥</span>
                </button>
            </div>

            <div class="mt-6 pt-4 border-t border-slate-700 flex justify-between items-center">
                <span class="text-xs text-slate-500" v-if="lastSyncTime">ä¸Šæ¬¡åŒæ­¥: {{ lastSyncTime }}</span>
                <span class="text-xs text-slate-500" v-else>å°šæœªåŒæ­¥</span>
                <button @click="clearStorage" class="text-xs text-red-400 hover:text-red-300">æ¸…é™¤è¨­å®š</button>
            </div>
        </div>
    </div>

    <div v-if="showAddPaddlerModal" class="fixed inset-0 bg-black/80 z-[60] flex items-end sm:items-center justify-center p-4 pb-10 sm:pb-4 animate-fade-in">
        <div class="bg-slate-800 p-6 rounded-xl w-full max-w-sm border border-slate-600 shadow-2xl mb-safe">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
                <span v-if="addMode === 'bench'" class="text-dragon-accent"><i class="fa-solid fa-user-plus"></i> æ–°å¢è‡¨æ™‚äººå“¡</span>
                <span v-else class="text-dragon-success"><i class="fa-solid fa-chair"></i> ç›´æ¥å…¥åº§</span>
            </h3>
            <input ref="nameInput" v-model="newPaddlerName" placeholder="è¼¸å…¥å§“å..." 
                   class="w-full bg-slate-900 p-4 rounded-lg border border-slate-700 mb-4 text-white text-lg focus:outline-none focus:border-dragon-accent placeholder-slate-600"
                   @keyup.enter="confirmAddPaddler">
            <div class="grid grid-cols-3 gap-2 mb-6">
                <button @click="newPaddlerSide = 'left'" :class="['py-3 rounded-lg border text-sm font-bold transition', newPaddlerSide==='left'?'bg-dragon-water text-white border-dragon-water':'bg-slate-800 border-slate-600 text-slate-400']">å·¦æ§³</button>
                <button @click="newPaddlerSide = 'right'" :class="['py-3 rounded-lg border text-sm font-bold transition', newPaddlerSide==='right'?'bg-green-600 text-white border-green-600':'bg-slate-800 border-slate-600 text-slate-400']">å³æ§³</button>
                <button @click="newPaddlerSide = 'both'" :class="['py-3 rounded-lg border text-sm font-bold transition', newPaddlerSide==='both'?'bg-purple-600 text-white border-purple-600':'bg-slate-800 border-slate-600 text-slate-400']">ä¸é™</button>
            </div>
            <div class="flex gap-3">
                <button @click="showAddPaddlerModal = false" class="flex-1 py-3 rounded-lg bg-slate-700 font-bold text-slate-300">å–æ¶ˆ</button>
                <button @click="confirmAddPaddler" class="flex-1 py-3 rounded-lg bg-dragon-accent text-black font-bold shadow-lg shadow-cyan-500/20">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div v-if="showCreateBoatModal" class="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-xl w-full max-w-sm border border-slate-600 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-white">æ–°å¢é¾èˆŸ</h3>
            <div class="mb-4">
                <label class="block text-xs text-slate-400 mb-1">èˆ¹éšŠåç¨±</label>
                <input v-model="newBoatName" placeholder="ä¾‹å¦‚ï¼šæ··åˆçµ„ C" 
                       class="w-full bg-slate-900 p-3 rounded border border-slate-700 text-white focus:outline-none focus:border-dragon-accent">
            </div>
            <div class="mb-6">
                <label class="block text-xs text-slate-400 mb-2">èˆ¹å‹é¸æ“‡</label>
                <div class="grid grid-cols-2 gap-3">
                    <button @click="newBoatType = 'big'" 
                            :class="['p-4 rounded border flex flex-col items-center transition', newBoatType === 'big' ? 'bg-dragon-accent/20 border-dragon-accent text-dragon-accent' : 'bg-slate-900 border-slate-700 text-slate-500']">
                        <span class="text-2xl mb-1"><i class="fa-solid fa-ship"></i></span>
                        <span class="font-bold">å¤§é¾ (18äºº)</span>
                    </button>
                    <button @click="newBoatType = 'small'" 
                            :class="['p-4 rounded border flex flex-col items-center transition', newBoatType === 'small' ? 'bg-dragon-accent/20 border-dragon-accent text-dragon-accent' : 'bg-slate-900 border-slate-700 text-slate-500']">
                        <span class="text-xl mb-1 mt-1"><i class="fa-solid fa-sailboat"></i></span>
                        <span class="font-bold">å°é¾ (10äºº)</span>
                    </button>
                </div>
            </div>
            <div class="flex gap-3">
                <button @click="showCreateBoatModal = false" class="flex-1 py-3 rounded bg-slate-700 text-slate-300 font-bold">å–æ¶ˆ</button>
                <button @click="confirmCreateBoat" class="flex-1 py-3 rounded bg-dragon-accent text-black font-bold">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <div v-if="selectedFrom" class="fixed bottom-6 left-4 right-4 z-50 flex gap-2 justify-center animate-slide-up max-w-md mx-auto">
        <div class="bg-slate-800 text-white px-4 py-3 rounded-lg shadow-xl border border-slate-600 flex flex-col justify-center items-start flex-1 min-w-0">
            <span class="text-[10px] text-slate-400 uppercase tracking-wider">å·²é¸å–</span>
            <span class="font-bold truncate w-full text-dragon-accent flex items-center text-sm">
                <i class="fa-solid fa-check-circle mr-2"></i> {{ getSelectedName() }}
            </span>
        </div>
        <button v-if="isSelectedEmptySeat()" @click="openAddPaddlerModal('seat')" 
                class="bg-dragon-success text-white px-4 py-3 rounded-lg shadow-xl font-bold hover:bg-green-600 transition flex items-center gap-2 whitespace-nowrap">
            <i class="fa-solid fa-plus"></i> <span class="hidden xs:inline">å…¥åº§</span>
        </button>
        <button v-if="isSelectedOnBoat() && !isSelectedEmptySeat()" @click="removeSelectedFromBoat" 
                class="bg-dragon-danger text-white px-4 py-3 rounded-lg shadow-xl font-bold hover:bg-red-600 transition flex items-center gap-2 whitespace-nowrap">
            <i class="fa-solid fa-arrow-down"></i> <span class="hidden xs:inline">ä¸‹èˆ¹</span>
        </button>
        <button @click="cancelSelection" class="bg-slate-600 text-white px-4 py-3 rounded-lg shadow-xl font-bold whitespace-nowrap active:bg-slate-500">
            <i class="fa-solid fa-xmark"></i>
        </button>
    </div>

</div>

<script>
    const { createApp, ref, computed, nextTick, onMounted } = Vue;

    createApp({
        setup() {
            const createEmptySeats = (rows) => ({ drummer: null, steersman: null, left: Array(rows).fill(null), right: Array(rows).fill(null) });

            // State
            const boats = ref([
                { id: 1, name: 'å¤§é¾ A', rowCount: 9, seats: createEmptySeats(9) },
                { id: 2, name: 'å°é¾ B', rowCount: 5, seats: createEmptySeats(5) }
            ]);
            
            const attendanceDB = ref({});
            const availableDates = ref([]);
            const selectedDate = ref("");
            const bench = ref([]);
            
            // Sync State
            const showSyncModal = ref(false);
            const syncMethod = ref('file');
            const csvUrl = ref('');
            const isLoading = ref(false);
            const lastSyncTime = ref('');

            // UI State
            const currentBoatIndex = ref(0);
            const showAddPaddlerModal = ref(false);
            const showCreateBoatModal = ref(false);
            const addMode = ref('bench');
            const nameInput = ref(null);
            const newPaddlerName = ref('');
            const newPaddlerSide = ref('both');
            const newBoatName = ref('');
            const newBoatType = ref('big');
            const selectedFrom = ref(null); 
            const selectedIndex = ref(null); 
            const selectedBoatIndex = ref(null); 

            const currentBoat = computed(() => boats.value[currentBoatIndex.value] || null);

            // --- Initialization ---
            onMounted(() => {
                const savedUrl = localStorage.getItem('dragon_csv_url');
                const savedData = localStorage.getItem('dragon_csv_data');
                const savedTime = localStorage.getItem('dragon_sync_time');
                
                if (savedUrl) csvUrl.value = savedUrl;
                if (savedTime) lastSyncTime.value = savedTime;

                if (savedData) {
                    parseCSV(savedData);
                } else if (savedUrl) {
                    fetchCsvFromUrl(); 
                } else {
                    showSyncModal.value = true; 
                }
            });

            // --- New CSV Logic (Vertical Roster) ---
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    processCsvText(text);
                    showSyncModal.value = false;
                    alert("æª”æ¡ˆè®€å–æˆåŠŸï¼");
                };
                reader.readAsText(file);
            };

            const processCsvText = (text) => {
                parseCSV(text);
                localStorage.setItem('dragon_csv_data', text);
                const now = new Date().toLocaleString();
                localStorage.setItem('dragon_sync_time', now);
                lastSyncTime.value = now;
            };

            const openSyncModal = () => showSyncModal.value = true;

            const fetchCsvFromUrl = async () => {
                if (!csvUrl.value) return;
                // Using Proxy to allow fetching Google Sheets CSV from localhost/file://
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(csvUrl.value);
                
                isLoading.value = true;
                try {
                    const res = await fetch(proxyUrl);
                    if (!res.ok) throw new Error("Network response was not ok");
                    const text = await res.text();
                    if (!text || text.length < 10) throw new Error("æŠ“å–åˆ°çš„è³‡æ–™ç‚ºç©º");

                    processCsvText(text);
                    localStorage.setItem('dragon_csv_url', csvUrl.value);
                    showSyncModal.value = false;
                    alert("åŒæ­¥æˆåŠŸï¼");

                } catch (e) {
                    console.error(e);
                    alert("åŒæ­¥å¤±æ•—ï¼š" + e.message + "\n\nå»ºè­°ï¼šè«‹æ”¹ç”¨ã€Œä¸Šå‚³æª”æ¡ˆã€åŠŸèƒ½ï¼Œé¸æ“‡æ‚¨å‰›æ‰ä¸‹è¼‰çš„ CSVã€‚");
                } finally {
                    isLoading.value = false;
                }
            };

            const clearStorage = () => {
                if(!confirm("ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰åŒæ­¥è¨­å®šå—ï¼Ÿ")) return;
                localStorage.removeItem('dragon_csv_url');
                localStorage.removeItem('dragon_csv_data');
                localStorage.removeItem('dragon_sync_time');
                attendanceDB.value = {};
                availableDates.value = [];
                bench.value = [];
                selectedDate.value = '';
                csvUrl.value = '';
                lastSyncTime.value = '';
                alert("å·²é‡ç½®");
            };

            const parseCSV = (csvText) => {
                const lines = csvText.trim().split(/\r?\n/); 
                if (lines.length < 10) return; // File too short

                // 1. Find Header Row (Usually Row 0)
                const headers = lines[0].split(',').map(h => h.trim());
                
                // 2. Find Data Start Row (Look for 'åå–®' in Col 0)
                let startRow = 7; // Default based on your file
                for(let i=0; i<20; i++) { // Search first 20 lines
                    if(lines[i] && lines[i].startsWith('åå–®')) {
                        startRow = i;
                        break;
                    }
                }

                // 3. Build "Side Map" from Col 1 & 2 (Index 1 & 2)
                // Col 1 = Left (Based on summary 'å·¦æ§³' in Row 0?), Col 2 = Right
                const sideMap = {};
                for(let i = startRow; i < lines.length; i++) {
                    const row = lines[i].split(',').map(c => c.trim());
                    if (row.length < 3) continue;
                    
                    if(row[1] && isName(row[1])) sideMap[row[1]] = 'left';
                    if(row[2] && isName(row[2])) sideMap[row[2]] = 'right';
                }

                // 4. Parse Dates (Columns 4 onwards)
                const db = {};
                const validDateCols = [];
                
                for(let j = 4; j < headers.length; j++) {
                    if(headers[j]) {
                        validDateCols.push({ index: j, date: headers[j] });
                        db[headers[j]] = [];
                    }
                }

                // 5. Scan Attendance
                for(let colObj of validDateCols) {
                    const j = colObj.index;
                    const dateKey = colObj.date;
                    
                    for(let i = startRow; i < lines.length; i++) {
                        const row = lines[i].split(',').map(c => c.trim());
                        if(row.length <= j) continue;
                        
                        const name = row[j];
                        if(isName(name)) {
                            db[dateKey].push({
                                id: `${name}-${dateKey}-${i}`, // Unique ID
                                name: name,
                                side: sideMap[name] || 'both' // Default to both/purple if not in side map
                            });
                        }
                    }
                }

                attendanceDB.value = db;
                // Reverse to show newest first
                availableDates.value = validDateCols.map(d => d.date).reverse();

                if (availableDates.value.length > 0 && !selectedDate.value) {
                     selectedDate.value = availableDates.value[0];
                     loadAttendanceForDate();
                }
            };

            const isName = (str) => {
                if(!str) return false;
                if(['on going', 'NaN', 'undefined', 'å‡ºå¸­åå–®'].includes(str)) return false;
                // Filter out numbers (e.g. counts in row 1-6)
                if(!isNaN(str) && !isNaN(parseFloat(str))) return false;
                return true;
            };

            // --- Core Logic ---
            const loadAttendanceForDate = () => {
                if (!selectedDate.value || !attendanceDB.value[selectedDate.value]) return;
                bench.value = JSON.parse(JSON.stringify(attendanceDB.value[selectedDate.value]));
                cancelSelection();
            };

            const getAttendanceCount = (date) => attendanceDB.value[date] ? attendanceDB.value[date].length : 0;
            
            const clearAllBoats = () => {
                if(!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰èˆ¹éš»åº§ä½å—ï¼Ÿ")) return;
                boats.value.forEach(boat => {
                    boat.seats.drummer = null;
                    boat.seats.steersman = null;
                    boat.seats.left.fill(null);
                    boat.seats.right.fill(null);
                });
            };

            const isOnBoat = (paddlerId) => {
                for (const boat of boats.value) {
                    if (boat.seats.drummer?.id === paddlerId) return true;
                    if (boat.seats.steersman?.id === paddlerId) return true;
                    if (boat.seats.left.some(p => p?.id === paddlerId)) return true;
                    if (boat.seats.right.some(p => p?.id === paddlerId)) return true;
                }
                return false;
            };

            // --- Interaction ---
            const getPaddlerName = (paddler) => paddler ? paddler.name : (paddler === null ? '' : '-');
            const getSeatClass = (section, index) => {
                if (!currentBoat.value) return '';
                const boat = currentBoat.value;
                if ((section === 'left' || section === 'right') && boat.seats[section][index] === undefined) return 'opacity-0 pointer-events-none';
                const isSelectedHere = selectedBoatIndex.value === currentBoatIndex.value && selectedFrom.value === section && selectedIndex.value === index;
                let content = (section === 'drummer' || section === 'steersman') ? boat.seats[section] : boat.seats[section][index];
                if (isSelectedHere) return content ? 'bg-dragon-accent text-black border-dragon-accent selected-pulse z-20 shadow-lg' : 'bg-slate-800 border-dragon-success text-dragon-success selected-empty-pulse z-20 shadow-lg';
                if (content) return 'bg-slate-700 text-white border-slate-500 shadow-md';
                return 'bg-slate-900/30 text-slate-600 border-dashed border-slate-800 hover:border-slate-600';
            };

            const handleBenchClick = (index) => {
                if (selectedFrom.value === 'bench' && selectedIndex.value === index) cancelSelection();
                else if (selectedFrom.value) executeSwap('bench', index, null);
                else { selectedFrom.value = 'bench'; selectedIndex.value = index; selectedBoatIndex.value = null; }
            };

            const handleSeatClick = (section, index) => {
                if (selectedBoatIndex.value === currentBoatIndex.value && selectedFrom.value === section && selectedIndex.value === index) { cancelSelection(); return; }
                if (selectedFrom.value) executeSwap(section, index, currentBoatIndex.value);
                else { selectedFrom.value = section; selectedIndex.value = index; selectedBoatIndex.value = currentBoatIndex.value; }
            };

            const executeSwap = (targetSection, targetIndex, targetBoatIdx) => {
                let sourceVal, targetVal;
                if (selectedFrom.value === 'bench') sourceVal = bench.value[selectedIndex.value];
                else {
                    const srcBoat = boats.value[selectedBoatIndex.value];
                    sourceVal = ['drummer', 'steersman'].includes(selectedFrom.value) ? srcBoat.seats[selectedFrom.value] : srcBoat.seats[selectedFrom.value][selectedIndex.value];
                }
                if (targetSection === 'bench') targetVal = bench.value[targetIndex];
                else {
                    const tgtBoat = boats.value[targetBoatIdx];
                    targetVal = ['drummer', 'steersman'].includes(targetSection) ? tgtBoat.seats[targetSection] : tgtBoat.seats[targetSection][targetIndex];
                }

                if (!sourceVal && !targetVal) { cancelSelection(); return; }

                if (selectedFrom.value !== 'bench') {
                    const srcBoat = boats.value[selectedBoatIndex.value];
                    if (['drummer', 'steersman'].includes(selectedFrom.value)) srcBoat.seats[selectedFrom.value] = targetVal;
                    else srcBoat.seats[selectedFrom.value][selectedIndex.value] = targetVal;
                }
                if (targetSection !== 'bench') {
                    const tgtBoat = boats.value[targetBoatIdx];
                    const valToPlace = (selectedFrom.value === 'bench') ? {...sourceVal} : sourceVal; 
                    if (['drummer', 'steersman'].includes(targetSection)) tgtBoat.seats[targetSection] = valToPlace;
                    else tgtBoat.seats[targetSection][targetIndex] = valToPlace;
                }
                cancelSelection();
            };

            // Helpers
            const isSelectedOnBoat = () => selectedBoatIndex.value !== null;
            const isSelectedEmptySeat = () => {
                if (!isSelectedOnBoat()) return false;
                const boat = boats.value[selectedBoatIndex.value];
                const s = selectedFrom.value;
                const i = selectedIndex.value;
                try { return (['drummer', 'steersman'].includes(s)) ? boat.seats[s] === null : boat.seats[s][i] === null; } catch (e) { return false; }
            };
            const removeSelectedFromBoat = () => {
                if (!isSelectedOnBoat()) return;
                const boat = boats.value[selectedBoatIndex.value];
                if (['drummer', 'steersman'].includes(selectedFrom.value)) boat.seats[selectedFrom.value] = null;
                else boat.seats[selectedFrom.value][selectedIndex.value] = null;
                cancelSelection();
            };
            const openAddPaddlerModal = (mode) => { addMode.value = mode; newPaddlerName.value = ''; showAddPaddlerModal.value = true; nextTick(() => { if(nameInput.value) nameInput.value.focus(); }); };
            const confirmAddPaddler = () => {
                if (!newPaddlerName.value) return;
                const newGuy = { id: Date.now(), name: newPaddlerName.value, side: newPaddlerSide.value };
                if (addMode.value === 'bench') bench.value.push(newGuy);
                else {
                    const boat = boats.value[selectedBoatIndex.value];
                    if (['drummer', 'steersman'].includes(selectedFrom.value)) boat.seats[selectedFrom.value] = newGuy;
                    else boat.seats[selectedFrom.value][selectedIndex.value] = newGuy;
                    cancelSelection();
                }
                showAddPaddlerModal.value = false;
            };
            const confirmCreateBoat = () => {
                const name = newBoatName.value || `æ–°èˆ¹éšŠ ${boats.value.length + 1}`;
                const rows = newBoatType.value === 'big' ? 9 : 5;
                boats.value.push({ id: Date.now(), name: name, rowCount: rows, seats: createEmptySeats(rows) });
                currentBoatIndex.value = boats.value.length - 1;
                showCreateBoatModal.value = false;
                newBoatName.value = '';
            };
            const switchBoat = (index) => currentBoatIndex.value = index;
            const cancelSelection = () => { selectedFrom.value = null; selectedIndex.value = null; selectedBoatIndex.value = null; };
            const getSelectedName = () => {
                if (selectedFrom.value === 'bench') return bench.value[selectedIndex.value]?.name;
                if (selectedBoatIndex.value === null) return '';
                const boat = boats.value[selectedBoatIndex.value];
                if(!boat) return '';
                const val = ['drummer', 'steersman'].includes(selectedFrom.value) ? boat.seats[selectedFrom.value] : boat.seats[selectedFrom.value][selectedIndex.value];
                return val ? val.name : 'ç©ºä½';
            };
            const countPaddlers = (boat, side) => boat ? boat.seats[side].filter(p => p !== null).length : 0;
            const countTotal = (boat) => {
                if(!boat) return 0;
                let count = 0;
                if(boat.seats.drummer) count++;
                if(boat.seats.steersman) count++;
                count += countPaddlers(boat, 'left');
                count += countPaddlers(boat, 'right');
                return count;
            };

            return {
                boats, currentBoatIndex, currentBoat, bench,
                selectedFrom, selectedIndex, selectedBoatIndex,
                showAddPaddlerModal, addMode, newPaddlerName, newPaddlerSide, nameInput,
                showCreateBoatModal, newBoatName, newBoatType,
                showSyncModal, syncMethod, csvUrl, isLoading, lastSyncTime,
                getPaddlerName, getSeatClass, handleBenchClick, handleSeatClick,
                switchBoat, cancelSelection, getSelectedName,
                openAddPaddlerModal, confirmAddPaddler, confirmCreateBoat,
                isSelectedEmptySeat, isSelectedOnBoat, removeSelectedFromBoat,
                countPaddlers, countTotal, fetchCsvFromUrl, handleFileUpload,
                openSyncModal, clearStorage, availableDates, selectedDate, loadAttendanceForDate, getAttendanceCount, isOnBoat, clearAllBoats
            };
        }
    }).mount('#app');
</script>
</body>
</html>