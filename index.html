<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Paddle Zelos æˆ°è¡“æ¿ (Neon Data)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // æ ¹æ“šåƒè€ƒåœ–æå–çš„é¡è‰²
                        neon: {
                            green: '#39ff14', // è¢å…‰ç¶  (é¸ä¸­/å¼·èª¿)
                            blue: '#00f0ff',  // è¢å…‰è— (ç§‘æŠ€/è¼”åŠ©)
                        },
                        tech: {
                            bg: '#0a0e17',    // æ¥µæ·±èƒŒæ™¯
                            card: '#111827',  // å¡ç‰‡èƒŒæ™¯
                            border: 'rgba(56, 189, 248, 0.2)', // è—è‰²å¾®å…‰é‚Šæ¡†
                            hover: 'rgba(56, 189, 248, 0.1)'
                        },
                        dragon: {
                            danger: '#ff3333', // é®®ç´… (åˆªé™¤/è­¦å‘Š)
                        }
                    },
                    boxShadow: {
                        'neon-green': '0 0 10px rgba(57, 255, 20, 0.5), 0 0 20px rgba(57, 255, 20, 0.3)',
                        'neon-blue': '0 0 10px rgba(0, 240, 255, 0.5), 0 0 20px rgba(0, 240, 255, 0.3)',
                    },
                    animation: { 'spin-slow': 'spin 3s linear infinite' }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #0a0e17; /* æ¥µæ·±èƒŒæ™¯ */
            background-image: radial-gradient(circle at 50% 0%, rgba(0, 240, 255, 0.05) 0%, transparent 50%); /* å¾®å¼±é ‚éƒ¨è—å…‰ */
            color: #e5e7eb; /* æ·ºç°ç™½æ–‡å­—ï¼Œæ¯”ç´”ç™½æ›´èˆ’é© */
            -webkit-tap-highlight-color: transparent; 
            font-family: "Inter", system-ui, -apple-system, sans-serif;
        }
        
        /* ç§‘æŠ€é¢æ¿ - æ·±è‰²ã€ç´®å¯¦ã€å¾®å…‰é‚Šæ¡† */
        .tech-panel {
            background: rgba(17, 24, 39, 0.8); /* æ·±è‰²åŠé€æ˜ */
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(0, 240, 255, 0.15); /* è—è‰²å¾®å…‰é‚Šæ¡† */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        /* èˆ¹èº«å½¢ç‹€ */
        .boat-shape {
            clip-path: polygon(20% 0%, 80% 0%, 100% 5%, 100% 100%, 0% 100%, 0% 5%);
            transition: all 0.3s ease-in-out;
            background: rgba(17, 24, 39, 0.95); /* å¹¾ä¹ä¸é€æ˜çš„æ·±è‰²èˆ¹èº« */
            border: 1px solid rgba(0, 240, 255, 0.2);
        }

        .seat-transition { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* è¢å…‰ç¶ é¸å–ç‹€æ…‹ (åƒè€ƒåœ–é¢¨æ ¼) */
        .selected-seat { 
            border: 2px solid #39ff14 !important; /* å¼·çƒˆè¢å…‰ç¶ é‚Šæ¡† */
            box-shadow: 0 0 12px rgba(57, 255, 20, 0.6) !important; /* ç¶ è‰²å…‰æšˆ */
            background-color: rgba(57, 255, 20, 0.1) !important;
            color: #39ff14 !important;
            z-index: 20;
        }
        
        /* ç©ºä½é¸å–ç‹€æ…‹ */
        .selected-empty { 
            border: 2px dashed #39ff14 !important;
            box-shadow: 0 0 8px rgba(57, 255, 20, 0.4) !important;
            z-index: 20;
            animation: pulse-green-border 1.5s infinite;
        }

        @keyframes pulse-green-border {
            0%, 100% { border-color: rgba(57, 255, 20, 0.4); }
            50% { border-color: #39ff14; }
        }

        /* ä¸€èˆ¬åº§ä½æ¨£å¼ */
        .seat-filled {
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .seat-empty {
            background: rgba(17, 24, 39, 0.5);
            border: 1px dashed rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.4);
        }

        /* è‡ªå®šç¾©ä¸‹æ‹‰é¸å–®ç®­é ­ */
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2339ff14' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); /* ç¶ è‰²ç®­é ­ */
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
            padding-right: 2rem;
            -webkit-appearance: none; appearance: none;
        }
        option { color: white; background-color: #111827; padding: 8px; }
    </style>
</head>
<body>

<div id="app" v-cloak class="min-h-screen flex flex-col pb-36 bg-tech-bg">
    <header class="tech-panel p-2 sticky top-0 z-50 border-b-0 border-b-tech-border rounded-b-xl mx-1 mt-1">
        <div class="flex justify-between items-center mb-2 px-1">
            <div class="flex items-center gap-2">
                <h1 class="font-bold text-sm tracking-wider text-white">Paddle Zelos <span class="text-[10px] text-neon-blue/80 font-normal ml-1">Data</span></h1>
            </div>
            <div class="flex gap-2">
                <button @click="clearAllBoats" class="bg-tech-card hover:bg-tech-hover text-dragon-danger px-3 py-1.5 rounded text-[10px] border border-tech-border/50 transition">
                    <i class="fa-solid fa-trash-can"></i> æ¸…ç©º
                </button>
                <button @click="forceRefresh" class="bg-tech-card hover:bg-tech-hover text-neon-blue px-3 py-1.5 rounded text-[10px] border border-tech-border/50 transition shadow-sm shadow-neon-blue/20">
                    <i :class="['fa-solid', isLoading ? 'fa-circle-notch fa-spin' : 'fa-rotate']"></i> <span v-if="hasPreset">æ›´æ–°</span><span v-else>è¨­å®š</span>
                </button>
            </div>
        </div>
        
        <div class="relative w-full">
            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                <i class="fa-regular fa-calendar text-neon-green/80 text-xs"></i>
            </div>
            <select v-model="selectedDate" @change="loadAttendanceForDate" 
                    class="bg-tech-card border border-tech-border text-white text-xs rounded focus:ring-1 focus:ring-neon-green focus:border-neon-green block w-full pl-9 p-2.5">
                <option value="" disabled>
                    {{ isLoading ? 'è³‡æ–™è®€å–ä¸­...' : (availableDates.length > 0 ? 'è«‹é¸æ“‡ç·´ç¿’æ—¥æœŸ...' : 'ç„¡è³‡æ–™') }}
                </option>
                <option v-for="date in availableDates" :key="date" :value="date">
                    {{ date }} ({{ getAttendanceCount(date) }}äºº)
                </option>
            </select>
        </div>
    </header>

    <div class="flex overflow-x-auto p-1 gap-2 sticky top-[90px] z-40 no-scrollbar px-2 py-2">
        <button 
            v-for="(boat, index) in boats" 
            :key="boat.id"
            @click="switchBoat(index)"
            :class="['px-4 py-1.5 rounded-md whitespace-nowrap text-xs font-bold transition-all border tech-panel', 
                     currentBoatIndex === index ? 'border-neon-green text-neon-green shadow-neon-green/30' : 'border-tech-border/30 text-slate-400 hover:text-white hover:border-tech-border']"
        >
            <span v-if="selectedBoatIndex === index" class="text-neon-green animate-pulse text-[8px] mr-1">â—</span>
            <span>{{ boat.name }}</span>
        </button>
        <button @click="showCreateBoatModal = true" class="px-3 py-1.5 rounded-md tech-panel text-slate-400 border border-tech-border/30 hover:text-white hover:border-tech-border transition text-xs">
            <i class="fa-solid fa-plus"></i>
        </button>
    </div>

    <div class="p-2 max-w-md mx-auto w-full flex-grow" v-if="currentBoat">
        
        <div class="boat-shape p-2 pb-8 relative mx-auto transition-all duration-500"
             :style="{ minHeight: currentBoat.rowCount === 9 ? '480px' : '320px' }">
            
            <div class="flex justify-center mb-2">
                <div @click="handleSeatClick('drummer', 0)" 
                     :class="['w-10 h-10 rounded-full flex items-center justify-center flex-col cursor-pointer seat-transition relative overflow-hidden shadow-lg', 
                              getSeatClass('drummer', 0)]">
                    <span class="text-[6px] uppercase font-bold opacity-50 mb-px">Drum</span>
                    <span class="text-[10px] font-bold truncate w-full text-center px-0.5 z-10 relative leading-none">
                        {{ getPaddlerName(currentBoat.seats.drummer) }}
                    </span>
                </div>
            </div>

            <div class="space-y-1.5">
                <div v-for="row in currentBoat.rowCount" :key="row" class="flex justify-between items-center gap-1.5">
                    <div @click="handleSeatClick('left', row-1)" 
                         :class="['flex-1 h-9 rounded flex items-center justify-between px-1 cursor-pointer seat-transition relative overflow-hidden group shadow-sm',
                                  getSeatClass('left', row-1)]">
                        <span class="text-[8px] font-mono opacity-30 absolute top-0.5 left-1">{{ row }}L</span>
                        <span class="font-bold text-xs truncate w-full text-center z-10">{{ getPaddlerName(currentBoat.seats.left[row-1]) }}</span>
                    </div>

                    <div class="w-3 flex justify-center">
                        <span class="text-[8px] text-slate-600 font-mono">{{ row }}</span>
                    </div>

                    <div @click="handleSeatClick('right', row-1)" 
                         :class="['flex-1 h-9 rounded flex items-center justify-between px-1 cursor-pointer seat-transition relative overflow-hidden group shadow-sm',
                                  getSeatClass('right', row-1)]">
                        <span class="text-[8px] font-mono opacity-30 absolute top-0.5 right-1">{{ row }}R</span>
                        <span class="font-bold text-xs truncate w-full text-center z-10">{{ getPaddlerName(currentBoat.seats.right[row-1]) }}</span>
                    </div>
                </div>
            </div>

            <div class="flex justify-center mt-4">
                <div @click="handleSeatClick('steersman', 0)" 
                     :class="['w-10 h-10 rounded-full flex items-center justify-center flex-col cursor-pointer seat-transition relative overflow-hidden shadow-lg',
                              getSeatClass('steersman', 0)]">
                    <span class="text-[6px] uppercase font-bold opacity-50 mb-px">Helm</span>
                    <span class="text-[10px] font-bold truncate w-full text-center px-0.5 z-10 relative leading-none">
                        {{ getPaddlerName(currentBoat.seats.steersman) }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-[#0a0e17]/95 backdrop-blur border-t-2 border-neon-blue/20 pb-8 pt-3 px-4 z-30 rounded-t-2xl shadow-[0_-5px_20px_rgba(0,240,255,0.1)]">
        <div class="flex justify-between items-center mb-2">
            <h3 class="text-slate-300 font-bold text-[10px] uppercase tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-clipboard-user text-neon-blue"></i> 
                <span v-if="selectedDate">{{ selectedDate }} ({{ bench.length }})</span>
                <span v-else>è«‹é¸æ—¥æœŸ</span>
            </h3>
            <button @click="openAddPaddlerModal('bench')" class="text-[10px] px-3 py-1 rounded bg-tech-card border border-tech-border text-slate-300 hover:text-white hover:border-neon-blue/50 transition">
                <i class="fa-solid fa-plus"></i> è‡¨æ™‚äººå“¡
            </button>
        </div>

        <div class="grid grid-cols-4 gap-2 max-h-40 overflow-y-auto p-1">
            <div v-for="(paddler, index) in bench" :key="paddler.id" 
                 @click="handleBenchClick(index)"
                 :class="['p-1 rounded bg-tech-card border border-tech-border/30 text-center cursor-pointer active:scale-95 transition relative min-h-[36px] flex flex-col justify-center select-none',
                          selectedFrom === 'bench' && selectedIndex === index ? 'selected-seat' : 'hover:border-neon-blue/50 hover:text-white',
                          isOnBoat(paddler.id) ? 'opacity-25 grayscale' : '']">
                <div class="text-[11px] font-bold truncate w-full">{{ paddler.name }}</div>
                <div v-if="isOnBoat(paddler.id)" class="absolute inset-0 flex items-center justify-center">
                    <i class="fa-solid fa-check text-neon-green text-lg drop-shadow"></i>
                </div>
            </div>
            <div v-if="bench.length === 0" class="col-span-4 text-center py-6 text-slate-500 text-xs italic border border-dashed border-tech-border/30 rounded bg-tech-card/50">
                <div v-if="isLoading">
                    <p><i class="fa-solid fa-circle-notch fa-spin text-neon-blue"></i> è®€å–ä¸­...</p>
                </div>
                <div v-else-if="availableDates.length === 0">
                    <p v-if="hasPreset" class="text-dragon-danger">è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚</p>
                    <p v-else class="mb-2">å°šæœªè¨­å®šåå–®é€£çµ</p>
                    <button v-if="!hasPreset" @click="openSyncModal" class="mt-2 text-neon-blue underline">è¨­å®š</button>
                </div>
                <div v-else-if="!selectedDate">
                    <p>â˜ï¸ è«‹é¸æ“‡æ—¥æœŸ</p>
                </div>
                <div v-else>
                    <p>ç„¡äººå ±å ğŸ˜´</p>
                </div>
            </div>
        </div>
    </div>

    <div v-if="showSyncModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[80] flex items-center justify-center p-4 animate-fade-in">
        <div class="tech-panel p-6 rounded-xl w-full max-w-lg shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-white flex justify-between items-center">
                <span><i class="fa-solid fa-rotate mr-2 text-neon-blue"></i>è¨­å®š</span>
                <button @click="showSyncModal = false" class="text-slate-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </h3>
            
            <div class="flex gap-2 mb-4 border-b border-tech-border/30 pb-1">
                <button @click="syncMethod = 'file'" :class="['px-4 py-2 text-sm font-bold border-b-2 transition-colors', syncMethod === 'file' ? 'border-neon-green text-neon-green' : 'border-transparent text-slate-400']">ä¸Šå‚³æª”æ¡ˆ</button>
                <button @click="syncMethod = 'url'" :class="['px-4 py-2 text-sm font-bold border-b-2 transition-colors', syncMethod === 'url' ? 'border-neon-green text-neon-green' : 'border-transparent text-slate-400']">CSV é€£çµ</button>
            </div>

            <div v-if="syncMethod === 'file'">
                <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-tech-border/30 border-dashed rounded-xl cursor-pointer bg-tech-card hover:bg-tech-card/80 transition hover:border-neon-blue/50">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl text-slate-400 mb-2"></i>
                        <p class="text-sm text-slate-300">é»æ“Šä¸Šå‚³ CSV</p>
                    </div>
                    <input type="file" class="hidden" accept=".csv" @change="handleFileUpload" />
                </label>
            </div>

            <div v-if="syncMethod === 'url'">
                <input v-model="csvUrl" placeholder="è²¼ä¸Š CSV é€£çµ" 
                       class="w-full bg-tech-card p-3 rounded-md border border-tech-border/50 text-sm text-white focus:outline-none focus:border-neon-green mb-3 placeholder-slate-500">
                <button @click="fetchCsvFromUrl" :disabled="isLoading" class="w-full py-3 rounded-md bg-neon-green text-black font-bold shadow-lg shadow-neon-green/20 flex justify-center items-center gap-2 hover:bg-[#2eff00] transition">
                    <i v-if="isLoading" class="fa-solid fa-circle-notch fa-spin"></i>
                    <span v-else>åŒæ­¥</span>
                </button>
            </div>
        </div>
    </div>

    <div v-if="showAddPaddlerModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-end sm:items-center justify-center p-4 pb-10 sm:pb-4 animate-fade-in">
        <div class="tech-panel p-6 rounded-xl w-full max-w-sm shadow-2xl mb-safe">
            <h3 class="text-xl font-bold mb-4 flex items-center gap-2 text-white">
                <span v-if="addMode === 'bench'" class="text-neon-blue"><i class="fa-solid fa-user-plus"></i> æ–°å¢è‡¨æ™‚</span>
                <span v-else class="text-neon-green"><i class="fa-solid fa-chair"></i> ç›´æ¥å…¥åº§</span>
            </h3>
            <input ref="nameInput" v-model="newPaddlerName" placeholder="è¼¸å…¥å§“å..." 
                   class="w-full bg-tech-card p-4 rounded-md border border-tech-border/50 mb-4 text-white text-lg focus:outline-none focus:border-neon-green placeholder-slate-500"
                   @keyup.enter="confirmAddPaddler">
            
            <div class="flex gap-3">
                <button @click="showAddPaddlerModal = false" class="flex-1 py-3 rounded-md bg-tech-card border border-tech-border/30 font-bold text-slate-300 hover:text-white transition">å–æ¶ˆ</button>
                <button @click="confirmAddPaddler" class="flex-1 py-3 rounded-md bg-neon-green text-black font-bold shadow-lg shadow-neon-green/20 hover:bg-[#2eff00] transition">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div v-if="showCreateBoatModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
        <div class="tech-panel p-6 rounded-xl w-full max-w-sm shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-white">æ–°å¢é¾èˆŸ</h3>
            <div class="mb-4">
                <label class="block text-xs text-slate-400 mb-1">èˆ¹éšŠåç¨±</label>
                <input v-model="newBoatName" placeholder="ä¾‹å¦‚ï¼šæ··åˆçµ„ C" 
                       class="w-full bg-tech-card p-3 rounded-md border border-tech-border/50 text-white focus:outline-none focus:border-neon-green placeholder-slate-500">
            </div>
            <div class="mb-6">
                <label class="block text-xs text-slate-400 mb-2">èˆ¹å‹é¸æ“‡</label>
                <div class="grid grid-cols-2 gap-3">
                    <button @click="newBoatType = 'big'" 
                            :class="['p-4 rounded-md border flex flex-col items-center transition', newBoatType === 'big' ? 'border-neon-green text-neon-green shadow-neon-green/20 bg-neon-green/10' : 'bg-tech-card border-tech-border/30 text-slate-400']">
                        <span class="text-2xl mb-1"><i class="fa-solid fa-ship"></i></span>
                        <span class="font-bold">å¤§é¾ (18äºº)</span>
                    </button>
                    <button @click="newBoatType = 'small'" 
                            :class="['p-4 rounded-md border flex flex-col items-center transition', newBoatType === 'small' ? 'border-neon-green text-neon-green shadow-neon-green/20 bg-neon-green/10' : 'bg-tech-card border-tech-border/30 text-slate-400']">
                        <span class="text-xl mb-1 mt-1"><i class="fa-solid fa-sailboat"></i></span>
                        <span class="font-bold">å°é¾ (10äºº)</span>
                    </button>
                </div>
            </div>
            <div class="flex gap-3">
                <button @click="showCreateBoatModal = false" class="flex-1 py-3 rounded-md bg-tech-card border border-tech-border/30 text-slate-300 font-bold hover:text-white transition">å–æ¶ˆ</button>
                <button @click="confirmCreateBoat" class="flex-1 py-3 rounded-md bg-neon-green text-black font-bold shadow-lg shadow-neon-green/20 hover:bg-[#2eff00] transition">å»ºç«‹</button>
            </div>
        </div>
    </div>

    <div v-if="selectedFrom" class="fixed bottom-6 left-4 right-4 z-50 flex gap-2 justify-center animate-slide-up max-w-md mx-auto">
        
        <div v-if="isSelectedEmptySeat()" class="flex-1 flex gap-2 items-center tech-panel p-2 rounded-lg shadow-2xl border border-neon-green/30">
            <div class="flex-1 relative">
                <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                    <i class="fa-solid fa-user-plus text-neon-green"></i>
                </div>
                <select @change="quickPlacePaddler($event)" class="w-full bg-tech-card border border-tech-border/50 text-white text-sm rounded focus:ring-neon-green focus:border-neon-green block pl-9 p-2.5 appearance-none">
                    <option selected disabled value="">å¿«é€Ÿå…¥åº§ ({{ availableBench.length }}äºº)</option>
                    <option value="NEW">+ æ–°å¢è‡¨æ™‚äººå“¡</option>
                    <option v-for="p in availableBench" :key="p.id" :value="JSON.stringify(p)">{{ p.name }}</option>
                </select>
            </div>
            <button @click="cancelSelection" class="bg-tech-card border border-tech-border/30 text-white w-10 h-10 rounded flex items-center justify-center hover:bg-tech-hover transition">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>

        <div v-else class="flex gap-2 w-full">
            <div class="tech-panel text-white px-4 py-3 rounded-lg shadow-2xl border border-neon-green/30 flex flex-col justify-center items-start flex-1 min-w-0">
                <span class="text-[10px] text-neon-green uppercase tracking-wider">å·²é¸å–</span>
                <span class="font-bold truncate w-full text-white flex items-center text-sm shadow-sm">
                    <i class="fa-solid fa-check-circle mr-2 text-neon-green"></i> {{ getSelectedName() }}
                </span>
            </div>
            <button @click="removeSelectedFromBoat" class="bg-dragon-danger/90 border border-red-500/30 text-white px-4 py-3 rounded-lg shadow-xl font-bold hover:bg-red-600 transition flex items-center gap-2 whitespace-nowrap">
                <i class="fa-solid fa-arrow-down"></i> <span class="hidden xs:inline">ä¸‹èˆ¹</span>
            </button>
            <button @click="cancelSelection" class="bg-tech-card border border-tech-border/30 text-white px-4 py-3 rounded-lg shadow-xl font-bold whitespace-nowrap hover:bg-tech-hover transition">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, nextTick, onMounted, watch } = Vue;

    // ==========================================
    // ğŸ”¥ è¨­å®šå€ï¼šè«‹åœ¨é€™è£¡è²¼ä¸Šä½ çš„ Google CSV é€£çµ
    // ==========================================
    const PRESET_CSV_URL = ''; 
    // ä¾‹å¦‚ï¼š 'https://docs.google.com/spreadsheets/d/e/......./pub?output=csv'

    createApp({
        setup() {
            const createEmptySeats = (rows) => ({ drummer: null, steersman: null, left: Array(rows).fill(null), right: Array(rows).fill(null) });

            // State
            const boats = ref([
                { id: 1, name: 'å¤§é¾ A', rowCount: 9, seats: createEmptySeats(9) },
                { id: 2, name: 'å°é¾ B', rowCount: 5, seats: createEmptySeats(5) }
            ]);
            
            const attendanceDB = ref({});
            const availableDates = ref([]);
            const selectedDate = ref("");
            const bench = ref([]);
            const hasPreset = ref(false);
            
            const showSyncModal = ref(false);
            const syncMethod = ref('file');
            const csvUrl = ref('');
            const isLoading = ref(false);
            const lastSyncTime = ref('');

            const currentBoatIndex = ref(0);
            const showAddPaddlerModal = ref(false);
            const showCreateBoatModal = ref(false);
            const addMode = ref('bench');
            const nameInput = ref(null);
            const newPaddlerName = ref('');
            const newBoatName = ref('');
            const newBoatType = ref('big');
            const selectedFrom = ref(null); 
            const selectedIndex = ref(null); 
            const selectedBoatIndex = ref(null); 

            const currentBoat = computed(() => boats.value[currentBoatIndex.value] || null);

            // --- SAVE & LOAD STATE (LocalStorage) ---
            const saveState = () => {
                try {
                    localStorage.setItem('dragon_boats_state', JSON.stringify(boats.value));
                    localStorage.setItem('dragon_selected_date', selectedDate.value);
                } catch (e) { console.error("Save failed", e); }
            };

            const loadState = () => {
                const savedBoats = localStorage.getItem('dragon_boats_state');
                if (savedBoats) {
                    try {
                        boats.value = JSON.parse(savedBoats);
                    } catch (e) { console.error("Load failed", e); }
                }
                const savedDate = localStorage.getItem('dragon_selected_date');
                if (savedDate) selectedDate.value = savedDate;
            };

            // Watch for changes in boats to Auto-Save
            watch(boats, () => { saveState(); }, { deep: true });
            watch(selectedDate, () => { saveState(); });

            // --- Initialization ---
            onMounted(() => {
                loadState();

                if (PRESET_CSV_URL && PRESET_CSV_URL.length > 10) {
                    hasPreset.value = true;
                    csvUrl.value = PRESET_CSV_URL;
                    
                    const savedData = localStorage.getItem('dragon_csv_data');
                    if (savedData) {
                        parseCSV(savedData);
                        fetchCsvFromUrl(true); 
                    } else {
                        fetchCsvFromUrl();
                    }
                } else {
                    const savedUrl = localStorage.getItem('dragon_csv_url');
                    const savedData = localStorage.getItem('dragon_csv_data');
                    if (savedUrl) csvUrl.value = savedUrl;
                    if (savedData) parseCSV(savedData);
                    else showSyncModal.value = true;
                }
            });

            const forceRefresh = () => {
                if(hasPreset.value) fetchCsvFromUrl();
                else showSyncModal.value = true;
            }

            // --- Helper: Check if paddler is on ANY boat ---
            const isOnBoat = (paddlerId) => {
                for (const boat of boats.value) {
                    if (boat.seats.drummer?.id === paddlerId) return true;
                    if (boat.seats.steersman?.id === paddlerId) return true;
                    if (boat.seats.left.some(p => p?.id === paddlerId)) return true;
                    if (boat.seats.right.some(p => p?.id === paddlerId)) return true;
                }
                return false;
            };

            const availableBench = computed(() => {
                return bench.value.filter(p => !isOnBoat(p.id));
            });

            // --- Quick Place Logic ---
            const quickPlacePaddler = (event) => {
                const value = event.target.value;
                if (value === "NEW") {
                    openAddPaddlerModal('seat');
                    event.target.value = "";
                    return;
                }
                if (!value) return;
                try {
                    const paddler = JSON.parse(value);
                    const boat = boats.value[selectedBoatIndex.value];
                    if (['drummer', 'steersman'].includes(selectedFrom.value)) {
                        boat.seats[selectedFrom.value] = paddler;
                    } else {
                        boat.seats[selectedFrom.value][selectedIndex.value] = paddler;
                    }
                    cancelSelection();
                } catch (e) { console.error("Quick place error", e); }
            };

            // --- CSV / Sync Logic ---
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => { processCsvText(e.target.result); showSyncModal.value = false; alert("æª”æ¡ˆè®€å–æˆåŠŸï¼"); };
                reader.readAsText(file);
            };

            const processCsvText = (text) => {
                parseCSV(text);
                localStorage.setItem('dragon_csv_data', text);
                const now = new Date().toLocaleString();
                lastSyncTime.value = now;
            };

            const openSyncModal = () => {
                if(hasPreset.value) {
                    if(confirm("è¦ç«‹å³å¾é›²ç«¯æ›´æ–°åå–®å—ï¼Ÿ")) {
                        fetchCsvFromUrl();
                    }
                } else {
                    showSyncModal.value = true;
                }
            };

            const fetchCsvFromUrl = async (isBackground = false) => {
                if (!csvUrl.value) return;
                const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(csvUrl.value);
                if(!isBackground) isLoading.value = true;
                try {
                    const res = await fetch(proxyUrl);
                    if (!res.ok) throw new Error("Network err");
                    const text = await res.text();
                    if (!text || text.length < 10) throw new Error("Empty data");
                    processCsvText(text);
                    if(!hasPreset.value) localStorage.setItem('dragon_csv_url', csvUrl.value);
                    if(!isBackground) {
                        showSyncModal.value = false;
                        alert("åŒæ­¥æˆåŠŸï¼åå–®å·²æ›´æ–°ã€‚");
                    }
                } catch (e) { 
                    if(!isBackground) alert("åŒæ­¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é€£çµã€‚"); 
                } finally { 
                    if(!isBackground) isLoading.value = false; 
                }
            };

            const clearStorage = () => {
                if(!confirm("æ¸…é™¤è¨­å®šï¼Ÿ")) return;
                localStorage.removeItem('dragon_csv_url'); localStorage.removeItem('dragon_csv_data');
                attendanceDB.value = {}; availableDates.value = []; bench.value = []; selectedDate.value = ''; 
                if(!hasPreset.value) csvUrl.value = '';
                alert("å·²é‡ç½®");
            };

            const parseCSV = (csvText) => {
                const lines = csvText.trim().split(/\r?\n/); 
                if (lines.length < 10) return;
                const headers = lines[0].split(',').map(h => h.trim());
                let startRow = 7;
                for(let i=0; i<20; i++) { if(lines[i] && lines[i].startsWith('åå–®')) { startRow = i; break; } }

                const db = {};
                const validDateCols = [];
                for(let j = 4; j < headers.length; j++) { if(headers[j]) { validDateCols.push({ index: j, date: headers[j] }); db[headers[j]] = []; } }

                for(let colObj of validDateCols) {
                    const j = colObj.index;
                    const dateKey = colObj.date;
                    for(let i = startRow; i < lines.length; i++) {
                        const row = lines[i].split(',').map(c => c.trim());
                        if(row.length <= j) continue;
                        const name = row[j];
                        if(isName(name)) {
                            db[dateKey].push({ id: `${name}-${dateKey}-${i}`, name: name, side: 'both' });
                        }
                    }
                }
                attendanceDB.value = db;
                availableDates.value = validDateCols.map(d => d.date).reverse();
                if (availableDates.value.length > 0 && !selectedDate.value) { selectedDate.value = availableDates.value[0]; loadAttendanceForDate(); }
            };

            const isName = (str) => {
                if(!str) return false;
                if(['on going', 'NaN', 'undefined', 'å‡ºå¸­åå–®'].includes(str)) return false;
                if(!isNaN(str) && !isNaN(parseFloat(str))) return false;
                return true;
            };

            const loadAttendanceForDate = () => { if (!selectedDate.value || !attendanceDB.value[selectedDate.value]) return; bench.value = JSON.parse(JSON.stringify(attendanceDB.value[selectedDate.value])); cancelSelection(); };
            const getAttendanceCount = (date) => attendanceDB.value[date] ? attendanceDB.value[date].length : 0;
            const clearAllBoats = () => { if(!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ’ä½å—ï¼Ÿ\n(é€™æœƒè¦†è“‹æš«å­˜)")) return; boats.value.forEach(boat => { boat.seats.drummer=null; boat.seats.steersman=null; boat.seats.left.fill(null); boat.seats.right.fill(null); }); };

            // --- Interaction ---
            const getPaddlerName = (paddler) => paddler ? paddler.name : (paddler === null ? '' : '-');
            
            const getSeatClass = (section, index) => {
                if (!currentBoat.value) return '';
                const boat = currentBoat.value;
                if ((section === 'left' || section === 'right') && boat.seats[section][index] === undefined) return 'opacity-0 pointer-events-none';
                const isSelectedHere = selectedBoatIndex.value === currentBoatIndex.value && selectedFrom.value === section && selectedIndex.value === index;
                let content = (section === 'drummer' || section === 'steersman') ? boat.seats[section] : boat.seats[section][index];
                
                // Tech Seat Styles
                if (isSelectedHere) return content ? 'selected-seat' : 'selected-empty';
                if (content) return 'seat-filled';
                return 'seat-empty hover:border-neon-blue/50 transition';
            };

            const handleBenchClick = (index) => { if (selectedFrom.value === 'bench' && selectedIndex.value === index) cancelSelection(); else if (selectedFrom.value) executeSwap('bench', index, null); else { selectedFrom.value = 'bench'; selectedIndex.value = index; selectedBoatIndex.value = null; } };
            const handleSeatClick = (section, index) => { if (selectedBoatIndex.value === currentBoatIndex.value && selectedFrom.value === section && selectedIndex.value === index) { cancelSelection(); return; } if (selectedFrom.value) executeSwap(section, index, currentBoatIndex.value); else { selectedFrom.value = section; selectedIndex.value = index; selectedBoatIndex.value = currentBoatIndex.value; } };
            
            const executeSwap = (targetSection, targetIndex, targetBoatIdx) => {
                let sourceVal, targetVal;
                if (selectedFrom.value === 'bench') sourceVal = bench.value[selectedIndex.value];
                else { const srcBoat = boats.value[selectedBoatIndex.value]; sourceVal = ['drummer', 'steersman'].includes(selectedFrom.value) ? srcBoat.seats[selectedFrom.value] : srcBoat.seats[selectedFrom.value][selectedIndex.value]; }
                if (targetSection === 'bench') targetVal = bench.value[targetIndex];
                else { const tgtBoat = boats.value[targetBoatIdx]; targetVal = ['drummer', 'steersman'].includes(targetSection) ? tgtBoat.seats[targetSection] : tgtBoat.seats[targetSection][targetIndex]; }
                if (!sourceVal && !targetVal) { cancelSelection(); return; }
                if (selectedFrom.value !== 'bench') { const srcBoat = boats.value[selectedBoatIndex.value]; if (['drummer', 'steersman'].includes(selectedFrom.value)) srcBoat.seats[selectedFrom.value] = targetVal; else srcBoat.seats[selectedFrom.value][selectedIndex.value] = targetVal; }
                if (targetSection !== 'bench') { const tgtBoat = boats.value[targetBoatIdx]; const valToPlace = (selectedFrom.value === 'bench') ? {...sourceVal} : sourceVal; if (['drummer', 'steersman'].includes(targetSection)) tgtBoat.seats[targetSection] = valToPlace; else tgtBoat.seats[targetSection][targetIndex] = valToPlace; }
                cancelSelection();
            };
            const isSelectedEmptySeat = () => { if (selectedBoatIndex.value === null) return false; const boat = boats.value[selectedBoatIndex.value]; const s = selectedFrom.value; const i = selectedIndex.value; try { return (['drummer', 'steersman'].includes(s)) ? boat.seats[s] === null : boat.seats[s][i] === null; } catch (e) { return false; } };
            const removeSelectedFromBoat = () => { if (selectedBoatIndex.value === null) return; const boat = boats.value[selectedBoatIndex.value]; if (['drummer', 'steersman'].includes(selectedFrom.value)) boat.seats[selectedFrom.value] = null; else boat.seats[selectedFrom.value][selectedIndex.value] = null; cancelSelection(); };
            const openAddPaddlerModal = (mode) => { addMode.value = mode; newPaddlerName.value = ''; showAddPaddlerModal.value = true; nextTick(() => { if(nameInput.value) nameInput.value.focus(); }); };
            const confirmAddPaddler = () => { if (!newPaddlerName.value) return; const newGuy = { id: Date.now(), name: newPaddlerName.value, side: 'both' }; if (addMode.value === 'bench') bench.value.push(newGuy); else { const boat = boats.value[selectedBoatIndex.value]; if (['drummer', 'steersman'].includes(selectedFrom.value)) boat.seats[selectedFrom.value] = newGuy; else boat.seats[selectedFrom.value][selectedIndex.value] = newGuy; cancelSelection(); } showAddPaddlerModal.value = false; };
            const confirmCreateBoat = () => { const name = newBoatName.value || `æ–°èˆ¹éšŠ ${boats.value.length + 1}`; const rows = newBoatType.value === 'big' ? 9 : 5; boats.value.push({ id: Date.now(), name: name, rowCount: rows, seats: createEmptySeats(rows) }); currentBoatIndex.value = boats.value.length - 1; showCreateBoatModal.value = false; newBoatName.value = ''; };
            const switchBoat = (index) => currentBoatIndex.value = index;
            const cancelSelection = () => { selectedFrom.value = null; selectedIndex.value = null; selectedBoatIndex.value = null; };
            const getSelectedName = () => { if (selectedFrom.value === 'bench') return bench.value[selectedIndex.value]?.name; if (selectedBoatIndex.value === null) return ''; const boat = boats.value[selectedBoatIndex.value]; if(!boat) return ''; const val = ['drummer', 'steersman'].includes(selectedFrom.value) ? boat.seats[selectedFrom.value] : boat.seats[selectedFrom.value][selectedIndex.value]; return val ? val.name : 'ç©ºä½'; };
            const countPaddlers = (boat, side) => boat ? boat.seats[side].filter(p => p !== null).length : 0;
            const countTotal = (boat) => { if(!boat) return 0; let count = 0; if(boat.seats.drummer) count++; if(boat.seats.steersman) count++; count += countPaddlers(boat, 'left'); count += countPaddlers(boat, 'right'); return count; };

            return {
                boats, currentBoatIndex, currentBoat, bench, availableBench,
                selectedFrom, selectedIndex, selectedBoatIndex,
                showAddPaddlerModal, addMode, newPaddlerName, nameInput,
                showCreateBoatModal, newBoatName, newBoatType,
                showSyncModal, syncMethod, csvUrl, isLoading, lastSyncTime,
                getPaddlerName, getSeatClass, handleBenchClick, handleSeatClick,
                switchBoat, cancelSelection, getSelectedName,
                openAddPaddlerModal, confirmAddPaddler, confirmCreateBoat,
                isSelectedEmptySeat, removeSelectedFromBoat,
                countPaddlers, countTotal, fetchCsvFromUrl, handleFileUpload,
                openSyncModal, clearStorage, availableDates, selectedDate, loadAttendanceForDate, getAttendanceCount, isOnBoat, clearAllBoats,
                quickPlacePaddler, hasPreset, forceRefresh
            };
        }
    }).mount('#app');
</script>
</body>
</html>